-- OneFile_ESP_TP_PRO_Resize_Spectate_Grab_BugarCarro.client.lua
-- Ferramentas locais para o TEU jogo (admin/debug). Sem c√≥digo remoto.

-- ========= Servi√ßos =========
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local ContextActionService = game:GetService("ContextActionService")
local TweenService = game:GetService("TweenService")
local HttpService = game:GetService("HttpService")
local Lighting = game:GetService("Lighting")

local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

-- ========= Configura√ß√µes Globais (Otimiza√ß√£o para reduzir registros locais) =========
ESP_DEFAULT_ON = false
SHOW_NAME_DEFAULT = false
SHOW_HEALTH_DEFAULT = false
SHOW_DISTANCE_DEFAULT = false
SHOW_TRACERS_DEFAULT = false
ESP_POSITION_DEFAULT = "Topo"
ESP_MODE_DEFAULT = "Cheio"
TEAM_FILTER_DEFAULT = "Todos"

FILL_COLOR = Color3.fromRGB(255, 0, 0)
OUTLINE_COLOR = Color3.fromRGB(255, 255, 255)
TRACER_COLOR = Color3.fromRGB(0, 255, 0)
BOX_COLOR = Color3.fromRGB(255, 255, 255)
LINES_COLOR = Color3.fromRGB(0, 255, 0)

-- Aimbot Config Global
aimbotEnabled = false
aimbotFOV = 100
aimbotFOVZero = 0
aimbotSmooth = 5
aimbotTarget = "Cabe√ßa"
aimbotBind = Enum.KeyCode.Unknown
aimbotBindString = "None"
aimbotShowFOV = false
aimbotShowFOVZero = false
aimbotOnlyVisible = false
aimbotOnNPCs = false
aimbotMobile = false

-- Dropdown alvo
local targetDropdownOpen = false
local targetOptions = {"Cabe√ßa", "Peito"}

UI_TOGGLE_KEY = Enum.KeyCode.M
FREEFLY_TOGGLE_KEY = Enum.KeyCode.F
UNLOCK_MOUSE_KEY = Enum.KeyCode.P

-- Free-Fly manual
FREEFLY_SPEED = 50
FREEFLY_SPRINT_MULT = 2
FREEFLY_VERTICAL_SPEED = 30

-- Limites do painel
PANEL_MIN = Vector2.new(500, 400)
PANEL_MAX = Vector2.new(900, 700)

-- ========= Estado Global (Otimiza√ß√£o) =========
espEnabled = ESP_DEFAULT_ON
showName = SHOW_NAME_DEFAULT
showHealth = SHOW_HEALTH_DEFAULT
showDistance = SHOW_DISTANCE_DEFAULT
showTracers = SHOW_TRACERS_DEFAULT
espPosition = ESP_POSITION_DEFAULT
espMode = ESP_MODE_DEFAULT
teamFilter = TEAM_FILTER_DEFAULT
espAutoEnabled = false
showBox = false
showLines = false
linesMode = "Center"
showSkeleton = false

-- Player enhancements globais
speedBoostEnabled = false
speedBoostValue = 50
jumpPowerBoostEnabled = false
jumpPowerBoostValue = 100
infiniteJumpEnabled = false
antiKickEnabled = false

-- Valores originais
originalWalkSpeed = 16
originalJumpPower = 50

highlights = {}         -- [Character] = Highlight
overlays = {}           -- [Character] = BillboardGui
boxes = {}              -- [Character] = BoxHandles
linesFrames = {}        -- [Character] = Frame

-- Fly-to target
flightConn = nil
flightStartTime = 0
cancelling = false
noclipActive = false
savedCollide = {}

-- Free-fly manual
freeflyOn = false
freeflyConn = nil
inputStates = {W=false,A=false,S=false,D=false,Space=false,Shift=false,Ctrl=false}
freeflyStartCFrame = nil

-- UI state
panelVisible = false
prevMouseBehavior = nil
prevMouseIconEnabled = nil

-- Spectate
spectating = nil
savedSubject = nil
savedCamType = nil
spectateConn = nil

-- Grab system
grabbing = false
grabbedPlayer = nil
grabConn = nil
GRAB_DISTANCE = 3
GRAB_HEIGHT = 0

-- Bugar systems
buggingPlayers = {}
bugConn = nil
buggingCars = {}
bugCarConn = nil

-- Player selection
selectedPlayer = nil

-- ========= FUN√á√ïES AUXILIARES PARA LISTA DE JOGADORES =========
local function getPlayerTeam(player: Player): string
	if not player.Team then return "Sem Equipe" end
	return player.Team.Name
end

local function getPlayerTeamColor(player: Player): Color3
	if not player.Team then return Color3.fromRGB(128, 128, 128) end
	return player.TeamColor.Color
end

local function getPlayerHealth(player: Player): number?
	local char = player.Character
	if not char then return nil end
	local hum = char:FindFirstChildOfClass("Humanoid")
	if not hum then return nil end
	return hum.Health
end

local function getPlayerMaxHealth(player: Player): number?
	local char = player.Character
	if not char then return nil end
	local hum = char:FindFirstChildOfClass("Humanoid")
	if not hum then return nil end
	return hum.MaxHealth
end

local function getPlayerDistance(player: Player): number?
	local char = player.Character
	local myChar = LocalPlayer.Character
	if not char or not myChar then return nil end

	local myRoot = getPrimaryPart(myChar)
	local targetRoot = getPrimaryPart(char)
	if not myRoot or not targetRoot then return nil end

	return math.floor((targetRoot.Position - myRoot.Position).Magnitude + 0.5)
end

local function isPlayerAlive(player: Player): boolean
	local health = getPlayerHealth(player)
	return health and health > 0
end

local function formatPlayerInfo(player: Player): string
	local displayName = player.DisplayName or player.Name
	local username = player.Name
	local team = getPlayerTeam(player)
	local distance = getPlayerDistance(player)
	local health = getPlayerHealth(player)
	local maxHealth = getPlayerMaxHealth(player)
	local alive = isPlayerAlive(player)

	local info = string.format("%s (@%s)", displayName, username)
	if team ~= "Sem Equipe" then
		info = info .. string.format(" | %s", team)
	end
	if distance then
		info = info .. string.format(" | %dm", distance)
	end
	if health and maxHealth then
		info = info .. string.format(" | HP: %d/%d", math.floor(health), math.floor(maxHealth))
	end
	if not alive then
		info = info .. " | üíÄ MORTO"
	end

	return info
end

-- Fun√ß√£o para atualizar um bot√£o de jogador espec√≠fico
local function updatePlayerButton(player: Player, button: Frame)
	if not button or not button.Parent then return end

	local mainContainer = button:FindFirstChild("MainContainer")
	if not mainContainer then return end

	local infoLabel = mainContainer:FindFirstChild("InfoLabel")
	local teamIndicator = mainContainer:FindFirstChild("TeamIndicator")
	local healthBarBg = mainContainer:FindFirstChild("HealthBarBg")
	local statusLabel = mainContainer:FindFirstChild("StatusLabel")

	-- Atualizar informa√ß√µes secund√°rias
	if infoLabel then
		infoLabel.Text = formatPlayerInfo(player)
	end

	-- Atualizar indicador de equipe
	if teamIndicator then
		teamIndicator.BackgroundColor3 = getPlayerTeamColor(player)
	end

	-- Atualizar barra de vida
	if healthBarBg then
		local healthBar = healthBarBg:FindFirstChild("HealthBar")
		if healthBar then
			local health = getPlayerHealth(player)
			local maxHealth = getPlayerMaxHealth(player)
			local healthPercent = maxHealth and health and (health / maxHealth) or 0

			healthBar.Size = UDim2.new(healthPercent, 0, 1, 0)
			healthBar.BackgroundColor3 = healthPercent > 0.5 and Color3.fromRGB(0, 255, 0) or healthPercent > 0.25 and Color3.fromRGB(255, 255, 0) or Color3.fromRGB(255, 0, 0)
		end
	end

	-- Atualizar status
	if statusLabel then
		local alive = isPlayerAlive(player)
		statusLabel.TextColor3 = alive and Color3.fromRGB(0, 255, 0) or Color3.fromRGB(255, 0, 0)
		statusLabel.Text = alive and "VIVO" or "MORTO"
	end
end

-- Sistema de atualiza√ß√£o em tempo real
local function startRealTimeUpdates()
	task.spawn(function()
		while true do
			task.wait(0.5) -- Atualizar a cada 0.5 segundos

			for player, button in pairs(playerButtons) do
				if player and player.Parent and button and button.Parent then
					updatePlayerButton(player, button)
				end
			end
		end
	end)
end

-- Conectar eventos de mudan√ßa de equipe
local function setupPlayerEvents(player: Player)
	if not player then return end

	player:GetPropertyChangedSignal("Team"):Connect(function()
		local button = playerButtons[player]
		if button then
			updatePlayerButton(player, button)
		end
	end)

	player.CharacterAdded:Connect(function(character)
		task.wait(0.1)
		local button = playerButtons[player]
		if button then
			updatePlayerButton(player, button)
		end
	end)

	player.CharacterRemoving:Connect(function()
		local button = playerButtons[player]
		if button then
			updatePlayerButton(player, button)
		end
	end)
end

local function createPlayerButton(player)
	if not player or player == LocalPlayer then return end

	local btn = Instance.new("Frame")
	btn.Name = player.Name .. "_Enhanced"
	btn.Size = UDim2.new(1, -10, 0, 60) -- Maior para mais informa√ß√µes
	btn.BackgroundColor3 = Color3.fromRGB(45, 45, 55)
	btn.Parent = playersList
	Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 8)

	-- Indicador de sele√ß√£o lateral
	local selectionIndicator = Instance.new("Frame")
	selectionIndicator.Size = UDim2.new(0, 4, 1, -8)
	selectionIndicator.Position = UDim2.new(0, 2, 0, 4)
	selectionIndicator.BackgroundColor3 = Color3.fromRGB(0, 170, 255)
	selectionIndicator.Visible = false
	selectionIndicator.Parent = btn
	Instance.new("UICorner", selectionIndicator).CornerRadius = UDim.new(0, 2)

	-- Container principal
	local mainContainer = Instance.new("Frame")
	mainContainer.Size = UDim2.new(1, -8, 1, 0)
	mainContainer.Position = UDim2.new(0, 6, 0, 0)
	mainContainer.BackgroundTransparency = 1
	mainContainer.Parent = btn

	-- Nome e Display Name
	local nameLabel = Instance.new("TextLabel")
	nameLabel.Size = UDim2.new(0.6, 0, 0, 20)
	nameLabel.Position = UDim2.new(0, 0, 0, 2)
	nameLabel.BackgroundTransparency = 1
	nameLabel.Font = Enum.Font.GothamBold
	nameLabel.TextSize = 14
	nameLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
	nameLabel.TextXAlignment = Enum.TextXAlignment.Left
	nameLabel.Text = player.DisplayName .. " (@" .. player.Name .. ")"
	nameLabel.Parent = mainContainer

	-- Informa√ß√µes secund√°rias (equipe, dist√¢ncia, vida)
	local infoLabel = Instance.new("TextLabel")
	infoLabel.Size = UDim2.new(0.6, 0, 0, 16)
	infoLabel.Position = UDim2.new(0, 0, 0, 22)
	infoLabel.BackgroundTransparency = 1
	infoLabel.Font = Enum.Font.SourceSans
	infoLabel.TextSize = 12
	infoLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
	infoLabel.TextXAlignment = Enum.TextXAlignment.Left
	infoLabel.Text = formatPlayerInfo(player)
	infoLabel.Parent = mainContainer

	-- Indicador de equipe (canto superior direito)
	local teamIndicator = Instance.new("Frame")
	teamIndicator.Size = UDim2.new(0, 12, 0, 12)
	teamIndicator.Position = UDim2.new(1, -16, 0, 4)
	teamIndicator.BackgroundColor3 = getPlayerTeamColor(player)
	teamIndicator.Parent = mainContainer
	Instance.new("UICorner", teamIndicator).CornerRadius = UDim.new(1, 0)

	-- Barra de vida (parte inferior)
	local healthBarBg = Instance.new("Frame")
	healthBarBg.Size = UDim2.new(0.6, 0, 0, 6)
	healthBarBg.Position = UDim2.new(0, 0, 0, 42)
	healthBarBg.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
	healthBarBg.Parent = mainContainer
	Instance.new("UICorner", healthBarBg).CornerRadius = UDim.new(0, 3)

	local health = getPlayerHealth(player)
	local maxHealth = getPlayerMaxHealth(player)
	local healthPercent = maxHealth and health and (health / maxHealth) or 0

	local healthBar = Instance.new("Frame")
	healthBar.Size = UDim2.new(healthPercent, 0, 1, 0)
	healthBar.BackgroundColor3 = healthPercent > 0.5 and Color3.fromRGB(0, 255, 0) or healthPercent > 0.25 and Color3.fromRGB(255, 255, 0) or Color3.fromRGB(255, 0, 0)
	healthBar.Parent = healthBarBg
	Instance.new("UICorner", healthBar).CornerRadius = UDim.new(0, 3)

	-- Status de vida (canto inferior direito)
	local statusLabel = Instance.new("TextLabel")
	statusLabel.Size = UDim2.new(0.35, 0, 0, 16)
	statusLabel.Position = UDim2.new(0.65, 0, 0, 40)
	statusLabel.BackgroundTransparency = 1
	statusLabel.Font = Enum.Font.SourceSansBold
	statusLabel.TextSize = 10
	statusLabel.TextColor3 = isPlayerAlive(player) and Color3.fromRGB(0, 255, 0) or Color3.fromRGB(255, 0, 0)
	statusLabel.TextXAlignment = Enum.TextXAlignment.Right
	statusLabel.Text = isPlayerAlive(player) and "VIVO" or "MORTO"
	statusLabel.Parent = mainContainer

	-- Bot√£o invis√≠vel para cliques
	local clickBtn = Instance.new("TextButton")
	clickBtn.Size = UDim2.new(1, 0, 1, 0)
	clickBtn.BackgroundTransparency = 1
	clickBtn.Text = ""
	clickBtn.Parent = btn

	clickBtn.MouseButton1Click:Connect(function()
		-- Desselecionar anterior
		for _, button in pairs(playerButtons) do
			if button:IsA("Frame") then
				local indicator = button:FindFirstChild("SelectionIndicator")
				if indicator then
					indicator.Visible = false
					button.BackgroundColor3 = Color3.fromRGB(45, 45, 55)
				end
			end
		end

		-- Selecionar atual
		selectionIndicator.Visible = true
		btn.BackgroundColor3 = Color3.fromRGB(60, 60, 75)
		selectedPlayer = player

		-- Mostrar painel de a√ß√µes
		if actionsPanel then
			actionsPanel.Visible = true
			if tpBtn then tpBtn.Visible = true end
			if spectateBtn then spectateBtn.Visible = true end
		spectateToggle.Visible = true
		end
	end)

	playerButtons[player] = btn
	return btn
end

local function buildPlayersOnce()
	for _, p in ipairs(Players:GetPlayers()) do
		if p ~= LocalPlayer and not playerButtons[p] then
			createPlayerButton(p)
		end
	end
end



Players.PlayerRemoving:Connect(function(p)
	if playerButtons[p] then
		playerButtons[p]:Destroy()
		playerButtons[p] = nil
	end
	if selectedPlayer == p then
		selectedPlayer = nil
		actionsPanel.Visible = false
	end
end)

local function applySearch(text)
	text = text:lower()

	for player, button in pairs(playerButtons) do
		if text == "" then
			button.Visible = true
		else
			local name = player.Name:lower()
			local display = player.DisplayName:lower()
			button.Visible = name:find(text) or display:find(text)
		end
	end
end



-- ========= NOVO SISTEMA DE FLY/NOCLIP =========
local FlySystem = {
    flying = false,
    noclip = false,
    speed = 1,  -- Come√ßa com velocidade 1
    bodyGyro = nil,
    bodyVelocity = nil,
    control = {F = 0, B = 0, L = 0, R = 0, U = 0, D = 0}
}

-- Fun√ß√£o para ativar/desativar Fly
function FlySystem:toggleFly()
    self.flying = not self.flying

    local character = LocalPlayer.Character
    if not character then return end

    local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
    local humanoid = character:FindFirstChild("Humanoid")
    if not humanoidRootPart or not humanoid then return end

    -- Criar ou remover controles de voo
    if self.flying then
        -- Ativar Fly
        self.bodyGyro = Instance.new("BodyGyro", humanoidRootPart)
        self.bodyGyro.MaxTorque = Vector3.new(400000, 400000, 400000)
        self.bodyGyro.D = 1000
        self.bodyGyro.CFrame = humanoidRootPart.CFrame

        self.bodyVelocity = Instance.new("BodyVelocity", humanoidRootPart)
        self.bodyVelocity.MaxForce = Vector3.new(400000, 400000, 400000)
        self.bodyVelocity.Velocity = Vector3.new(0, 0, 0)

        print("ü™Ω Fly ATIVADO (Velocidade: " .. self.speed .. ")")
    else
        -- Desativar Fly
        if self.bodyGyro then self.bodyGyro:Destroy() end
        if self.bodyVelocity then self.bodyVelocity:Destroy() end
        self.bodyGyro = nil
        self.bodyVelocity = nil

        print("ü¶∂ Fly DESATIVADO")
    end
end

-- Fun√ß√£o para ativar/desativar Noclip
function FlySystem:toggleNoclip()
    self.noclip = not self.noclip
    print(self.noclip and "üîì Noclip ATIVADO" or "üîí Noclip DESATIVADO")
end

-- Fun√ß√£o para ajustar velocidade do Fly
function FlySystem:setSpeed(newSpeed)
    self.speed = math.clamp(newSpeed, 1, 100)
    print("‚ö° Velocidade do Fly ajustada para: " .. self.speed)
end

-- Configurar controles de teclado
function FlySystem:setupControls()
    -- Controles de movimento
    UserInputService.InputBegan:Connect(function(input, gpe)
        if gpe then return end

        if input.KeyCode == Enum.KeyCode.W then self.control.F = 1 end
        if input.KeyCode == Enum.KeyCode.S then self.control.B = 1 end
        if input.KeyCode == Enum.KeyCode.A then self.control.L = 1 end
        if input.KeyCode == Enum.KeyCode.D then self.control.R = 1 end
        if input.KeyCode == Enum.KeyCode.Space then self.control.U = 1 end
        if input.KeyCode == Enum.KeyCode.LeftControl then self.control.D = 1 end

        -- Teclas extras para controle de velocidade
        if input.KeyCode == Enum.KeyCode.Equals then
            self:setSpeed(self.speed + 5)
        elseif input.KeyCode == Enum.KeyCode.Minus then
            self:setSpeed(self.speed - 5)
        end
    end)

    UserInputService.InputEnded:Connect(function(input, gpe)
        if gpe then return end

        if input.KeyCode == Enum.KeyCode.W then self.control.F = 0 end
        if input.KeyCode == Enum.KeyCode.S then self.control.B = 0 end
        if input.KeyCode == Enum.KeyCode.A then self.control.L = 0 end
        if input.KeyCode == Enum.KeyCode.D then self.control.R = 0 end
        if input.KeyCode == Enum.KeyCode.Space then self.control.U = 0 end
        if input.KeyCode == Enum.KeyCode.LeftControl then self.control.D = 0 end
    end)

    print("üéÆ Controles do Fly configurados")
end

-- Loop principal de Fly
function FlySystem:startLoop()
    RunService.RenderStepped:Connect(function()
        local character = LocalPlayer.Character
        if not character then return end

        local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
        if not humanoidRootPart then return end

        -- Sistema Noclip
        if self.noclip then
            for _, v in pairs(character:GetDescendants()) do
                if v:IsA("BasePart") and v.CanCollide == true then
                    v.CanCollide = false
                end
            end
        end

        -- Sistema Fly
        if self.flying and humanoidRootPart then
            local cam = workspace.CurrentCamera
            local moveVec = Vector3.zero

            local forward = cam.CFrame.LookVector
            local right = cam.CFrame.RightVector
            local up = Vector3.new(0, 1, 0)

            -- Calcular dire√ß√£o do movimento
            moveVec = moveVec
                + forward * (self.control.F - self.control.B)
                + right * (self.control.R - self.control.L)
                + up * (self.control.U - self.control.D)

            -- Aplicar movimento
            if moveVec.Magnitude > 0 then
                moveVec = moveVec.Unit * self.speed
                humanoidRootPart.CFrame = humanoidRootPart.CFrame + moveVec
            end
        end
    end)

    print("üîÑ Loop do Fly iniciado")
end

-- Fun√ß√£o para resetar ao respawnar
function FlySystem:setupCharacterEvents()
    local function onCharacterAdded(char)
        -- Resetar fly e noclip ao respawnar
        self.flying = false
        self.noclip = false

        -- Limpar controles antigos
        if self.bodyGyro then self.bodyGyro:Destroy() end
        if self.bodyVelocity then self.bodyVelocity:Destroy() end
        self.bodyGyro = nil
        self.bodyVelocity = nil

        print("üîÑ Personagem respawnado - Fly/Noclip resetados")
    end

    LocalPlayer.CharacterAdded:Connect(onCharacterAdded)
    if LocalPlayer.Character then
        onCharacterAdded(LocalPlayer.Character)
    end
end

-- Inicializar sistema completo
function FlySystem:init()
    self:setupControls()
    self:setupCharacterEvents()
    self:startLoop()

    print("üöÄ Sistema de Fly/Noclip inicializado com sucesso!")
    print("üéÆ CONTROLES:")
    print("   F = Ativar/Desativar Fly")
    print("   W/A/S/D = Movimenta√ß√£o")
    print("   Espa√ßo = Subir | Ctrl = Descer")
    print("   +/- = Ajustar velocidade")

    return self
end

-- Inicializar o sistema
FlySystem:init()

-- Vari√°veis globais para compatibilidade - Sincronizadas
flying = FlySystem.flying
noclip = FlySystem.noclip
speed = FlySystem.speed

-- Fun√ß√µes de compatibilidade - Atualizam globais
function toggleFly()
    FlySystem:toggleFly()
    flying = FlySystem.flying
    noclip = FlySystem.noclip  -- Noclip √© ativado automaticamente com fly
end

function toggleNoclip()
    FlySystem:toggleNoclip()
    noclip = FlySystem.noclip
end

-- ========= Fun√ß√£o para Destravar Mouse =========
local function unlockMouse()
	-- For√ßar o mouse a voltar ao normal
	UserInputService.MouseBehavior = Enum.MouseBehavior.Default
	UserInputService.MouseIconEnabled = true

	-- For√ßar fechar o painel se estiver aberto
	if panelVisible then
		showPanel(false)
		print("üîì Painel fechado for√ßadamente junto com o mouse!")
	end

	-- Mostrar mensagem de confirma√ß√£o
	print("üîì Mouse destravado! (Tecla P)")

	-- Criar notifica√ß√£o visual tempor√°ria
	local playerGui = LocalPlayer:WaitForChild("PlayerGui")
	local notification = Instance.new("ScreenGui")
	notification.Name = "MouseUnlockNotification"
	notification.ResetOnSpawn = false
	notification.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
	notification.Parent = playerGui

	local frame = Instance.new("Frame")
	frame.Size = UDim2.new(0, 300, 0, 80)
	frame.Position = UDim2.new(0.5, -150, 0.1, 0)
	frame.BackgroundColor3 = Color3.fromRGB(0, 100, 0)
	frame.BorderSizePixel = 0
	frame.Parent = notification
	Instance.new("UICorner", frame).CornerRadius = UDim.new(0, 10)

	local label = Instance.new("TextLabel")
	label.Size = UDim2.new(1, 0, 1, 0)
	label.BackgroundTransparency = 1
	label.Text = "üîì MOUSE DESTRAVADO!\nTecla P pressionada"
	label.TextColor3 = Color3.new(1, 1, 1)
	label.Font = Enum.Font.GothamBold
	label.TextSize = 16
	label.TextWrapped = true
	label.Parent = frame

	-- Remover ap√≥s 3 segundos
	task.delay(3, function()
		notification:Destroy()
	end)
end

-- ========= Helpers =========
local function getPrimaryPart(char: Model?): BasePart?
	if not char then return nil end
	return char.PrimaryPart
		or char:FindFirstChild("HumanoidRootPart")
		or char:FindFirstChild("Torso")
		or char:FindFirstChild("UpperTorso")
end

local function getHead(char: Model?): BasePart?
	if not char then return nil end
	return char:FindFirstChild("Head") or getPrimaryPart(char)
end

local function forEachCharacterPart(char: Model, fn)
	for _, d in ipairs(char:GetDescendants()) do
		if d:IsA("BasePart") then fn(d) end
	end
end

local function isEnemy(p: Player): boolean
	if not LocalPlayer.Team or not p.Team then return false end
	return p.Team ~= LocalPlayer.Team
end

local function applyHighlightMode(highlight)
	if espMode == "Cheio" then
		highlight.FillTransparency = 0
		highlight.OutlineTransparency = 0
	else
		highlight.FillTransparency = 1
		highlight.OutlineTransparency = 0
	end
end

local function ensureHighlight(character: Model)
	if not character or not character.Parent then return end
	local h = highlights[character]
	if not h or not h.Parent then
		h = Instance.new("Highlight")
		h.Name = "PlayerESP"
		h.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
		h.Adornee = character
		h.Parent = LocalPlayer:WaitForChild("PlayerGui")
		highlights[character] = h
	end

	-- Check visibility
	local camera = workspace.CurrentCamera
	local visible = true
	if camera then
		local targetRoot = getPrimaryPart(character)
		local myChar = LocalPlayer.Character
		if targetRoot and myChar then
			local myRoot = getPrimaryPart(myChar)
			if myRoot then
				-- Use character position for raycast to avoid first person issues
				local direction = (targetRoot.Position - myRoot.Position).Unit
				local distance = (targetRoot.Position - myRoot.Position).Magnitude
				local raycastResult = workspace:Raycast(myRoot.Position + Vector3.new(0, 2, 0), direction * distance)
				if raycastResult and raycastResult.Instance and not raycastResult.Instance:IsDescendantOf(character) then
					visible = false
				end
			end
		end
	end

	if espAutoEnabled then
		h.FillColor = visible and Color3.fromRGB(0, 255, 0) or Color3.fromRGB(255, 0, 0) -- Green if visible, red if not
	else
		h.FillColor = FILL_COLOR
	end
	h.OutlineColor = OUTLINE_COLOR
	applyHighlightMode(h)
	h.Enabled = espEnabled
end

local function ensureOverlayFor(p: Player, character: Model)
	if not character or not character.Parent then return end
	local bb = overlays[character]
	if not bb or not bb.Parent then
		local head = getHead(character); if not head then return end
		bb = Instance.new("BillboardGui")
		bb.Name = "ESP_Overlay"
		bb.Adornee = head
		bb.Size = UDim2.fromOffset(220, 36)
		bb.AlwaysOnTop = true
		bb.MaxDistance = 10000
		bb.Parent = LocalPlayer:WaitForChild("PlayerGui")

		local holder = Instance.new("Frame")
		holder.Name = "Holder"
		holder.BackgroundTransparency = 1 -- Fundo transparente
		holder.Size = UDim2.fromScale(1, 1)
		holder.Parent = bb

		local label = Instance.new("TextLabel")
		label.Name = "Text"
		label.BackgroundTransparency = 1 -- Fundo transparente
		label.Size = UDim2.fromScale(1, 1)
		label.Font = Enum.Font.GothamBold
		label.TextSize = 14
		label.TextColor3 = Color3.fromRGB(255,255,255)
		label.TextStrokeTransparency = 0.8 -- Contorno para melhor visibilidade
		label.TextStrokeColor3 = Color3.fromRGB(0,0,0)
		label.TextWrapped = true
		label.Text = ""
		label.Parent = holder

		overlays[character] = bb

		character.AncestryChanged:Connect(function(_, parent)
			if not parent then
				if overlays[character] then pcall(function() overlays[character]:Destroy() end) end
				overlays[character] = nil
				if highlights[character] then pcall(function() highlights[character]:Destroy() end) end
				highlights[character] = nil
			end
		end)
	end
end

local function overlayOffsetFor(positionName: string): Vector3
	if positionName == "Topo" then
		return Vector3.new(0, 2.6, 0)
	elseif positionName == "Baixo" then
		return Vector3.new(0, -2.0, 0)
	else
		return Vector3.new(2.5, 1.2, 0) -- direita
	end
end

local function ensureBox(character: Model)
	if not character or not character.Parent then return end
	local box = boxes[character]
	if not box or not box.Parent then
		box = Instance.new("BoxHandleAdornment")
		box.Name = "ESPBox"
		box.AlwaysOnTop = true
		box.ZIndex = 5
		box.Size = character:GetExtentsSize()
		box.Adornee = character
		box.Parent = LocalPlayer:WaitForChild("PlayerGui")
		boxes[character] = box
	end
	box.Color3 = BOX_COLOR
	box.Transparency = 0.7
	box.Visible = showBox and espEnabled
end

local function ensureLine(character: Model)
	if not character or not character.Parent then return end
	if not showLines or not espEnabled then
		if linesFrames[character] then
			linesFrames[character].Visible = false
		end
		return
	end
	
	local lineFrame = linesFrames[character]
	if not lineFrame or not lineFrame.Parent then
		lineFrame = Instance.new("Frame")
		lineFrame.Name = "ESPLine"
		lineFrame.BackgroundColor3 = LINES_COLOR
		lineFrame.BorderSizePixel = 0
		lineFrame.AnchorPoint = Vector2.new(0.5, 0)
		lineFrame.ZIndex = 10
		lineFrame.Parent = gui
		linesFrames[character] = lineFrame
	end
	lineFrame.BackgroundColor3 = LINES_COLOR
end

local function updateLine(character: Model)
	if not showLines or not espEnabled then
		if linesFrames[character] then
			linesFrames[character].Visible = false
		end
		return
	end
	
	local lineFrame = linesFrames[character]
	if not lineFrame then return end
	
	local camera = workspace.CurrentCamera
	local targetRoot = getPrimaryPart(character)
	if not targetRoot then
		lineFrame.Visible = false
		return
	end
	
	local targetPos, onScreen = camera:WorldToViewportPoint(targetRoot.Position)
	if not onScreen then
		lineFrame.Visible = false
		return
	end
	
	local startPos
	if linesMode == "Sky" then
		startPos = Vector2.new(camera.ViewportSize.X / 2, 0)
	else
		startPos = Vector2.new(camera.ViewportSize.X / 2, camera.ViewportSize.Y / 2)
	end
	
	local endPos = Vector2.new(targetPos.X, targetPos.Y)
	local distance = (endPos - startPos).Magnitude
	local angle = math.atan2(endPos.Y - startPos.Y, endPos.X - startPos.X)
	
	lineFrame.Size = UDim2.new(0, distance, 0, 2)
	lineFrame.Position = UDim2.new(0, startPos.X, 0, startPos.Y)
	lineFrame.Rotation = math.deg(angle)
	lineFrame.Visible = true
end

local function updateOverlay(p: Player, character: Model, bb: BillboardGui)
	if not bb then return end
	local head = getHead(character); if not head then return end
	bb.Adornee = head
	bb.StudsOffsetWorldSpace = overlayOffsetFor(espPosition)

	local bits = {}
	if showName then table.insert(bits, (p.DisplayName or p.Name)) end
	if showHealth then
		local hum = character:FindFirstChildOfClass("Humanoid"); if hum then table.insert(bits, ("HP: %d"):format(hum.Health + 0.5)) end
	end
	local label = bb:FindFirstChild("Holder") and bb.Holder:FindFirstChild("Text")
	if label and label:IsA("TextLabel") then label.Text = table.concat(bits, " | ") end

	local visibleByFilter = true
	if teamFilter == "S√≥ inimigos" then visibleByFilter = isEnemy(p) end

	local h = highlights[character]
	if h then
		h.FillColor = FILL_COLOR
		h.OutlineColor = OUTLINE_COLOR
		applyHighlightMode(h)
		h.Enabled = showSkeleton and espEnabled and visibleByFilter
	end
	bb.Enabled = espEnabled and (showName or showHealth) and visibleByFilter
	
	-- Atualizar Box
	ensureBox(character)
	
	-- Atualizar Line
	ensureLine(character)
	updateLine(character)
end

local function refreshESPForPlayer(p: Player)
	if p == LocalPlayer then return end
	local char = p.Character; if not char then return end
	if espEnabled then
		ensureHighlight(char)
		ensureOverlayFor(p, char)
		updateOverlay(p, char, overlays[char])
	else
		if overlays[char] then overlays[char].Enabled = false end
		if highlights[char] then highlights[char].Enabled = false end
	end
end

-- Sistema ESP Otimizado - Atualiza automaticamente ap√≥s morte
local function cleanupESPForCharacter(character)
	if overlays[character] then 
		pcall(function() overlays[character]:Destroy() end)
		overlays[character] = nil
	end
	if highlights[character] then 
		pcall(function() highlights[character]:Destroy() end)
		highlights[character] = nil
	end
	if boxes[character] then 
		pcall(function() boxes[character]:Destroy() end)
		boxes[character] = nil
	end
	if linesFrames[character] then 
		pcall(function() linesFrames[character]:Destroy() end)
		linesFrames[character] = nil
	end
end

-- Inicial + eventos de players
for _, plr in ipairs(Players:GetPlayers()) do
	if plr ~= LocalPlayer then
		if plr.Character then refreshESPForPlayer(plr) end
		
		-- Detectar quando personagem √© adicionado (spawn/respawn)
		plr.CharacterAdded:Connect(function(char)
			task.wait(0.5)
			refreshESPForPlayer(plr)
			
			-- Detectar morte para limpar ESP
			local hum = char:WaitForChild("Humanoid", 5)
			if hum then
				hum.Died:Connect(function()
					cleanupESPForCharacter(char)
				end)
			end
		end)
		
		-- Detectar quando personagem √© removido
		plr.CharacterRemoving:Connect(function(char)
			cleanupESPForCharacter(char)
		end)
		
		plr:GetPropertyChangedSignal("Team"):Connect(function() 
			refreshESPForPlayer(plr) 
		end)
	end
end

Players.PlayerAdded:Connect(function(plr)
	if plr ~= LocalPlayer then
		plr.CharacterAdded:Connect(function(char)
			task.wait(0.5)
			refreshESPForPlayer(plr)
			
			local hum = char:WaitForChild("Humanoid", 5)
			if hum then
				hum.Died:Connect(function()
					cleanupESPForCharacter(char)
				end)
			end
		end)
		
		plr.CharacterRemoving:Connect(function(char)
			cleanupESPForCharacter(char)
		end)
		
		plr:GetPropertyChangedSignal("Team"):Connect(function() 
			refreshESPForPlayer(plr) 
		end)
	end
end)

Players.PlayerRemoving:Connect(function(plr)
	if plr.Character then
		cleanupESPForCharacter(plr.Character)
	end
end)

-- Atualiza√ß√£o peri√≥dica otimizada (vida/nome/filtro/ESP)
task.spawn(function()
	while true do
		task.wait(0.1)
		for _, p in ipairs(Players:GetPlayers()) do
			if p ~= LocalPlayer and p.Character then
				local char = p.Character
				local bb = overlays[char]
				if bb and bb.Parent then
					updateOverlay(p, char, bb)
				end
				if espEnabled then
					if char and char.Parent then
						ensureHighlight(char)
						ensureBox(char)
						ensureLine(char)
						updateLine(char)
					end
				else
					if linesFrames[char] then
						linesFrames[char].Visible = false
					end
					if boxes[char] then
						boxes[char].Visible = false
					end
				end
			end
		end
	end
end)







-- ========= Spectate (c√¢mara) - VERS√ÉO FORNECIDA =========
local function startSpectate(p: Player)
    if not p or p == LocalPlayer then return end
    local targetChar = p.Character
    if not targetChar then return end
    local hum = targetChar:FindFirstChildOfClass("Humanoid")
    if not hum then return end

    if not savedSubject then savedSubject = Camera.CameraSubject end
    if not savedCamType then savedCamType = Camera.CameraType end

    Camera.CameraType = Enum.CameraType.Custom
    Camera.CameraSubject = hum
    spectating = p

    if spectateConn then spectateConn:Disconnect() end
    spectateConn = spectating.CharacterAdded:Connect(function(char)
        task.wait(0.1)
        local hum = char:FindFirstChildOfClass("Humanoid")
        if hum then
            Camera.CameraSubject = hum
        end
    end)
end

local function stopSpectate()
    if savedSubject then Camera.CameraSubject = savedSubject end
    if savedCamType then Camera.CameraType = savedCamType end
    spectating = nil
    if spectateConn then spectateConn:Disconnect() spectateConn = nil end
end

-- ========= Instant TP to Player =========
local function instantTPTo(targetPlayer: Player)
	if not targetPlayer or targetPlayer == LocalPlayer then return end
	local char = LocalPlayer.Character
	local targetChar = targetPlayer.Character
	if not char or not targetChar then return end
	local srcPart = getPrimaryPart(char)
	local dstPart = getPrimaryPart(targetChar)
	if not srcPart or not dstPart then return end
	local offset = Vector3.new(0,3,0)
	char:PivotTo(CFrame.new(dstPart.Position + offset, dstPart.Position + offset + dstPart.CFrame.LookVector))
end





-- Se o espectado respawnar, mant√©m
Players.PlayerAdded:Connect(function(p)
	if p == spectating then
		p.CharacterAdded:Connect(function(char)
			task.wait(0.1)
			local hum = char:FindFirstChildOfClass("Humanoid")
			if hum and spectating == p then
				Camera.CameraSubject = hum
			end
		end)
	end
end)

-- Sistema de verifica√ß√£o cont√≠nua do spectate
RunService.RenderStepped:Connect(function()
	if spectating and spectating.Parent then
		local targetChar = spectating.Character
		if not targetChar then
			stopSpectate()
			return
		end

		-- Garantir que a c√¢mera ainda est√° no modo correto
		if Camera.CameraType ~= Enum.CameraType.Custom or Camera.CameraSubject ~= hum then
			Camera.CameraType = Enum.CameraType.Custom
			Camera.CameraSubject = hum
		end
	else
		-- Jogador saiu do jogo
		if spectating then
			stopSpectate()
		end
	end
end)

-- ========= UI MODERNA E OTIMIZADA =========
local playerGui = LocalPlayer:WaitForChild("PlayerGui")
local gui = Instance.new("ScreenGui")
gui.Name = "AdminPanel"
gui.ResetOnSpawn = false
gui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
gui.Parent = playerGui



-- Main Frame
local mainFrame = Instance.new("Frame")
mainFrame.Name = "MainFrame"
mainFrame.Size = UDim2.new(0, 1100, 0, 750)
mainFrame.Position = UDim2.new(0.5, -550, 0.5, -375)
mainFrame.BackgroundColor3 = Color3.fromRGB(15, 15, 25)
mainFrame.BorderSizePixel = 0
mainFrame.ZIndex = 1
mainFrame.Parent = gui

local mainCorner = Instance.new("UICorner")
mainCorner.CornerRadius = UDim.new(0, 16)
mainCorner.Parent = mainFrame

local mainStroke = Instance.new("UIStroke")
mainStroke.Color = Color3.fromRGB(88, 101, 242)
mainStroke.Thickness = 2
mainStroke.Transparency = 0.5
mainStroke.Parent = mainFrame

-- Gradient de fundo
local bgGradient = Instance.new("UIGradient")
bgGradient.Color = ColorSequence.new{
    ColorSequenceKeypoint.new(0, Color3.fromRGB(15, 15, 25)),
    ColorSequenceKeypoint.new(1, Color3.fromRGB(20, 15, 30))
}
bgGradient.Rotation = 45
bgGradient.Parent = mainFrame

-- Header moderno
local header = Instance.new("Frame")
header.Size = UDim2.new(1, 0, 0, 60)
header.BackgroundColor3 = Color3.fromRGB(88, 101, 242)
header.BorderSizePixel = 0
header.Parent = mainFrame

local headerCorner = Instance.new("UICorner")
headerCorner.CornerRadius = UDim.new(0, 16)
headerCorner.Parent = header

local headerFix = Instance.new("Frame")
headerFix.Size = UDim2.new(1, 0, 0, 20)
headerFix.Position = UDim2.new(0, 0, 1, -20)
headerFix.BackgroundColor3 = Color3.fromRGB(88, 101, 242)
headerFix.BorderSizePixel = 0
headerFix.Parent = header

local headerGradient = Instance.new("UIGradient")
headerGradient.Color = ColorSequence.new{
    ColorSequenceKeypoint.new(0, Color3.fromRGB(88, 101, 242)),
    ColorSequenceKeypoint.new(1, Color3.fromRGB(139, 92, 246))
}
headerGradient.Parent = header

local title = Instance.new("TextLabel")
title.Size = UDim2.new(0.7, 0, 1, 0)
title.Position = UDim2.new(0, 25, 0, 0)
title.BackgroundTransparency = 1
title.Text = "‚ö° RODRI MENU PRO"
title.Font = Enum.Font.GothamBold
title.TextSize = 28
title.TextColor3 = Color3.fromRGB(255, 255, 255)
title.TextXAlignment = Enum.TextXAlignment.Left
title.Parent = header

local titleShadow = Instance.new("UIStroke")
titleShadow.Color = Color3.fromRGB(0, 0, 0)
titleShadow.Thickness = 2
titleShadow.Transparency = 0.5
titleShadow.Parent = title

local closeBtn = Instance.new("TextButton")
closeBtn.Size = UDim2.new(0, 40, 0, 40)
closeBtn.Position = UDim2.new(1, -50, 0.5, -20)
closeBtn.BackgroundColor3 = Color3.fromRGB(239, 68, 68)
closeBtn.Text = "‚úï"
closeBtn.Font = Enum.Font.GothamBold
closeBtn.TextSize = 24
closeBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
closeBtn.BorderSizePixel = 0
closeBtn.Parent = header

local closeBtnCorner = Instance.new("UICorner")
closeBtnCorner.CornerRadius = UDim.new(0, 10)
closeBtnCorner.Parent = closeBtn

local closeBtnStroke = Instance.new("UIStroke")
closeBtnStroke.Color = Color3.fromRGB(220, 38, 38)
closeBtnStroke.Thickness = 2
closeBtnStroke.Transparency = 0.3
closeBtnStroke.Parent = closeBtn

closeBtn.MouseEnter:Connect(function()
	closeBtn.BackgroundColor3 = Color3.fromRGB(220, 38, 38)
end)
closeBtn.MouseLeave:Connect(function()
	closeBtn.BackgroundColor3 = Color3.fromRGB(239, 68, 68)
end)
closeBtn.MouseButton1Click:Connect(function()
	showPanel(false)
end)

-- Tabs Container moderno
local tabsContainer = Instance.new("Frame")
tabsContainer.Size = UDim2.new(1, -20, 0, 50)
tabsContainer.Position = UDim2.new(0, 10, 0, 70)
tabsContainer.BackgroundColor3 = Color3.fromRGB(25, 25, 35)
tabsContainer.BackgroundTransparency = 0.3
tabsContainer.BorderSizePixel = 0
tabsContainer.Parent = mainFrame

local tabsCorner = Instance.new("UICorner")
tabsCorner.CornerRadius = UDim.new(0, 12)
tabsCorner.Parent = tabsContainer

local tabsStroke = Instance.new("UIStroke")
tabsStroke.Color = Color3.fromRGB(88, 101, 242)
tabsStroke.Thickness = 1
tabsStroke.Transparency = 0.7
tabsStroke.Parent = tabsContainer

-- Tabs
local tabs = {}
local currentTab = "PLAYERS"

local tabsList = Instance.new("Frame")
tabsList.Size = UDim2.new(1, -20, 1, -10)
tabsList.Position = UDim2.new(0, 10, 0, 5)
tabsList.BackgroundTransparency = 1
tabsList.Parent = tabsContainer

local tabsLayout = Instance.new("UIListLayout")
tabsLayout.FillDirection = Enum.FillDirection.Horizontal
tabsLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center
tabsLayout.Padding = UDim.new(0, 10)
tabsLayout.Parent = tabsList

local function createTab(name, text, icon)
	local tab = Instance.new("TextButton")
	tab.Size = UDim2.new(0, 240, 1, 0)
	tab.BackgroundColor3 = Color3.fromRGB(30, 30, 45)
	tab.BackgroundTransparency = 0.5
	tab.Text = icon .. "  " .. text
	tab.Font = Enum.Font.GothamBold
	tab.TextSize = 15
	tab.TextColor3 = Color3.fromRGB(200, 200, 220)
	tab.BorderSizePixel = 0
	tab.Parent = tabsList

	local tabCorner = Instance.new("UICorner")
	tabCorner.CornerRadius = UDim.new(0, 10)
	tabCorner.Parent = tab

	local tabStroke = Instance.new("UIStroke")
	tabStroke.Color = Color3.fromRGB(88, 101, 242)
	tabStroke.Thickness = 0
	tabStroke.Transparency = 0.5
	tabStroke.Parent = tab

	tabs[name] = tab

	tab.MouseEnter:Connect(function()
		if currentTab ~= name then
			tab.BackgroundTransparency = 0.3
		end
	end)
	tab.MouseLeave:Connect(function()
		if currentTab ~= name then
			tab.BackgroundTransparency = 0.5
		end
	end)
	tab.MouseButton1Click:Connect(function()
		setTab(name)
	end)

	return tab
end

local tabPlayers = createTab("PLAYERS", "JOGADORES", "üë•")
local tabESP = createTab("ESP", "VISUAL", "üëÅÔ∏è")
local tabAimbot = createTab("AIMBOT", "RAGE", "üéØ")
local tabUtil = createTab("UTIL", "MISC", "‚öôÔ∏è")

-- Content Area
local content = Instance.new("Frame")
content.Size = UDim2.new(1, -20, 1, -140)
content.Position = UDim2.new(0, 10, 0, 130)
content.BackgroundTransparency = 1
content.Parent = mainFrame

-- Pages
local pages = {}

local function createPage(name)
	local page = Instance.new("ScrollingFrame")
	page.Size = UDim2.new(1, 0, 1, 0)
	page.BackgroundTransparency = 1
	page.ScrollBarThickness = 6
	page.ScrollBarImageColor3 = Color3.fromRGB(88, 101, 242)
	page.ScrollBarImageTransparency = 0.3
	page.BorderSizePixel = 0
	page.Visible = false
	page.Parent = content

	local layout = Instance.new("UIListLayout")
	layout.Padding = UDim.new(0, 12)
	layout.HorizontalAlignment = Enum.HorizontalAlignment.Center
	layout.Parent = page

	pages[name] = page
	return page
end

local playersPage = createPage("PLAYERS")
local espPage = createPage("ESP")
local aimbotPage = createPage("AIMBOT")
local utilPage = createPage("UTIL")

-- Set initial tab com anima√ß√£o
local function setTab(tabName)
	for name, tab in pairs(tabs) do
		local tabStroke = tab:FindFirstChildOfClass("UIStroke")
		if name == tabName then
			tab.BackgroundColor3 = Color3.fromRGB(88, 101, 242)
			tab.BackgroundTransparency = 0
			tab.TextColor3 = Color3.fromRGB(255, 255, 255)
			if tabStroke then tabStroke.Thickness = 2 end
			pages[name].Visible = true
			currentTab = name
		else
			tab.BackgroundColor3 = Color3.fromRGB(30, 30, 45)
			tab.BackgroundTransparency = 0.5
			tab.TextColor3 = Color3.fromRGB(200, 200, 220)
			if tabStroke then tabStroke.Thickness = 0 end
			pages[name].Visible = false
		end
	end
end

setTab("PLAYERS")

-- Create categories com visual moderno
local function createCategory(parent, title)
	local category = Instance.new("Frame")
	category.Size = UDim2.new(0.98, 0, 0, 0)
	category.BackgroundColor3 = Color3.fromRGB(25, 25, 40)
	category.BackgroundTransparency = 0.2
	category.BorderSizePixel = 0
	category.Parent = parent

	local categoryCorner = Instance.new("UICorner")
	categoryCorner.CornerRadius = UDim.new(0, 12)
	categoryCorner.Parent = category

	local categoryStroke = Instance.new("UIStroke")
	categoryStroke.Color = Color3.fromRGB(88, 101, 242)
	categoryStroke.Thickness = 1
	categoryStroke.Transparency = 0.6
	categoryStroke.Parent = category

	local categoryGradient = Instance.new("UIGradient")
	categoryGradient.Color = ColorSequence.new{
		ColorSequenceKeypoint.new(0, Color3.fromRGB(25, 25, 40)),
		ColorSequenceKeypoint.new(1, Color3.fromRGB(30, 25, 45))
	}
	categoryGradient.Rotation = 90
	categoryGradient.Parent = category

	local titleLabel = Instance.new("TextLabel")
	titleLabel.Size = UDim2.new(1, -20, 0, 35)
	titleLabel.Position = UDim2.new(0, 15, 0, 10)
	titleLabel.BackgroundTransparency = 1
	titleLabel.Text = title
	titleLabel.Font = Enum.Font.GothamBold
	titleLabel.TextSize = 16
	titleLabel.TextColor3 = Color3.fromRGB(139, 92, 246)
	titleLabel.TextXAlignment = Enum.TextXAlignment.Left
	titleLabel.Parent = category

	local titleStroke = Instance.new("UIStroke")
	titleStroke.Color = Color3.fromRGB(0, 0, 0)
	titleStroke.Thickness = 1
	titleStroke.Transparency = 0.7
	titleStroke.Parent = titleLabel

	local contentFrame = Instance.new("Frame")
	contentFrame.Size = UDim2.new(1, -30, 1, -55)
	contentFrame.Position = UDim2.new(0, 15, 0, 45)
	contentFrame.BackgroundTransparency = 1
	contentFrame.Parent = category

	local contentLayout = Instance.new("UIListLayout")
	contentLayout.Padding = UDim.new(0, 8)
	contentLayout.Parent = contentFrame

	local function updateSize()
		local contentSize = contentLayout.AbsoluteContentSize
		category.Size = UDim2.new(0.98, 0, 0, contentSize.Y + 65)
	end

	contentLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(updateSize)

	return contentFrame
end

local function createToggle(parent, text, callback)
	local toggleFrame = Instance.new("Frame")
	toggleFrame.Size = UDim2.new(1, 0, 0, 42)
	toggleFrame.BackgroundColor3 = Color3.fromRGB(35, 35, 50)
	toggleFrame.BackgroundTransparency = 0.3
	toggleFrame.BorderSizePixel = 0
	toggleFrame.Parent = parent

	local toggleCorner = Instance.new("UICorner")
	toggleCorner.CornerRadius = UDim.new(0, 10)
	toggleCorner.Parent = toggleFrame

	local toggleStroke = Instance.new("UIStroke")
	toggleStroke.Color = Color3.fromRGB(60, 60, 80)
	toggleStroke.Thickness = 1
	toggleStroke.Transparency = 0.5
	toggleStroke.Parent = toggleFrame

	local label = Instance.new("TextLabel")
	label.Size = UDim2.new(1, -70, 1, 0)
	label.Position = UDim2.new(0, 15, 0, 0)
	label.BackgroundTransparency = 1
	label.Text = text
	label.Font = Enum.Font.GothamMedium
	label.TextSize = 14
	label.TextColor3 = Color3.fromRGB(220, 220, 240)
	label.TextXAlignment = Enum.TextXAlignment.Left
	label.Parent = toggleFrame

	-- Toggle switch moderno
	local switchBg = Instance.new("Frame")
	switchBg.Size = UDim2.new(0, 50, 0, 26)
	switchBg.Position = UDim2.new(1, -60, 0.5, -13)
	switchBg.BackgroundColor3 = Color3.fromRGB(60, 60, 70)
	switchBg.BorderSizePixel = 0
	switchBg.Parent = toggleFrame

	local switchCorner = Instance.new("UICorner")
	switchCorner.CornerRadius = UDim.new(1, 0)
	switchCorner.Parent = switchBg

	local switchBtn = Instance.new("TextButton")
	switchBtn.Size = UDim2.new(0, 22, 0, 22)
	switchBtn.Position = UDim2.new(0, 2, 0.5, -11)
	switchBtn.BackgroundColor3 = Color3.fromRGB(200, 200, 210)
	switchBtn.Text = ""
	switchBtn.BorderSizePixel = 0
	switchBtn.Parent = switchBg

	local btnCorner = Instance.new("UICorner")
	btnCorner.CornerRadius = UDim.new(1, 0)
	btnCorner.Parent = switchBtn

	local btnStroke = Instance.new("UIStroke")
	btnStroke.Color = Color3.fromRGB(255, 255, 255)
	btnStroke.Thickness = 2
	btnStroke.Transparency = 0.5
	btnStroke.Parent = switchBtn

	local enabled = false

	switchBtn.MouseButton1Click:Connect(function()
		enabled = not enabled
		if enabled then
			switchBg.BackgroundColor3 = Color3.fromRGB(88, 101, 242)
			TweenService:Create(switchBtn, TweenInfo.new(0.2, Enum.EasingStyle.Quad), {Position = UDim2.new(1, -24, 0.5, -11)}):Play()
			switchBtn.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
			toggleStroke.Color = Color3.fromRGB(88, 101, 242)
			toggleStroke.Transparency = 0.3
		else
			switchBg.BackgroundColor3 = Color3.fromRGB(60, 60, 70)
			TweenService:Create(switchBtn, TweenInfo.new(0.2, Enum.EasingStyle.Quad), {Position = UDim2.new(0, 2, 0.5, -11)}):Play()
			switchBtn.BackgroundColor3 = Color3.fromRGB(200, 200, 210)
			toggleStroke.Color = Color3.fromRGB(60, 60, 80)
			toggleStroke.Transparency = 0.5
		end
		if callback then callback(enabled) end
	end)

	toggleFrame.MouseEnter:Connect(function()
		toggleFrame.BackgroundTransparency = 0.1
	end)
	toggleFrame.MouseLeave:Connect(function()
		toggleFrame.BackgroundTransparency = 0.3
	end)

	return toggleFrame
end

-- üîß VERS√ÉO MELHORADA: Players Page com melhorias visuais e sistema de toggles
local playerButtons = {}
local playersCategory = createCategory(playersPage, "Lista de Jogadores")

-- Container para pesquisa e contador
local topContainer = Instance.new("Frame")
topContainer.Size = UDim2.new(1, 0, 0, 40)
topContainer.BackgroundTransparency = 1
topContainer.Parent = playersCategory

-- Campo de pesquisa (lado esquerdo)
local searchBox = Instance.new("TextBox")
searchBox.Size = UDim2.new(0.7, -5, 1, 0)
searchBox.Position = UDim2.new(0, 0, 0, 0)
searchBox.BackgroundColor3 = Color3.fromRGB(40, 40, 48)
searchBox.TextColor3 = Color3.fromRGB(255, 255, 255)
searchBox.PlaceholderText = "Pesquisar jogador..."
searchBox.Font = Enum.Font.SourceSans
searchBox.TextSize = 14
searchBox.Parent = topContainer
Instance.new("UICorner", searchBox).CornerRadius = UDim.new(0, 8)

-- Conectar pesquisa
searchBox:GetPropertyChangedSignal("Text"):Connect(function()
	if not searchBox or not searchBox.Parent then return end
	updatePlayersList()
end)

-- Contador de jogadores (lado direito)
local playerCounter = Instance.new("TextLabel")
playerCounter.Size = UDim2.new(0.3, -5, 1, 0)
playerCounter.Position = UDim2.new(0.7, 5, 0, 0)
playerCounter.BackgroundColor3 = Color3.fromRGB(30, 30, 40)
playerCounter.TextColor3 = Color3.fromRGB(200, 200, 255)
playerCounter.Font = Enum.Font.SourceSansBold
playerCounter.TextSize = 14
playerCounter.Text = "0 jogadores"
playerCounter.Parent = topContainer
Instance.new("UICorner", playerCounter).CornerRadius = UDim.new(0, 8)

-- Container para lista e a√ß√µes
local playersContainer = Instance.new("Frame")
playersContainer.Size = UDim2.new(1, 0, 0, 350)
playersContainer.BackgroundTransparency = 1
playersContainer.Parent = playersCategory

-- Lista de jogadores simples
local playersList = Instance.new("ScrollingFrame")
playersList.Size = UDim2.new(0.6, -5, 1, 0)
playersList.Position = UDim2.new(0, 0, 0, 0)
playersList.BackgroundColor3 = Color3.fromRGB(32, 32, 38)
playersList.BorderSizePixel = 0
playersList.ScrollBarThickness = 6
playersList.Parent = playersContainer
Instance.new("UICorner", playersList).CornerRadius = UDim.new(0, 8)

local playersLayout = Instance.new("UIListLayout")
playersLayout.Padding = UDim.new(0, 4)
playersLayout.Parent = playersList

playersLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
	playersList.CanvasSize = UDim2.new(0, 0, 0, playersLayout.AbsoluteContentSize.Y)
end)

-- Painel de a√ß√µes simples
local actionsPanel = Instance.new("Frame")
actionsPanel.Size = UDim2.new(0.35, -5, 1, 0)
actionsPanel.Position = UDim2.new(0.65, 5, 0, 0)
actionsPanel.BackgroundColor3 = Color3.fromRGB(30, 30, 70)
actionsPanel.BackgroundTransparency = 0.4
actionsPanel.Parent = playersContainer
Instance.new("UICorner", actionsPanel).CornerRadius = UDim.new(0, 12)

local actionsTitle = Instance.new("TextLabel")
actionsTitle.Size = UDim2.new(1, -20, 0, 30)
actionsTitle.Position = UDim2.new(0, 10, 0, 10)
actionsTitle.BackgroundTransparency = 1
actionsTitle.Text = "A√á√ïES DO JOGADOR"
actionsTitle.Font = Enum.Font.SourceSansBold
actionsTitle.TextSize = 14
actionsTitle.TextColor3 = Color3.fromRGB(196, 181, 253)
actionsTitle.TextXAlignment = Enum.TextXAlignment.Left
actionsTitle.Parent = actionsPanel

local actionsContainer = Instance.new("Frame")
actionsContainer.Size = UDim2.new(1, -20, 1, -50)
actionsContainer.Position = UDim2.new(0, 10, 0, 40)
actionsContainer.BackgroundTransparency = 1
actionsContainer.Parent = actionsPanel

local actionsLayout = Instance.new("UIListLayout")
actionsLayout.Padding = UDim.new(0, 8)
actionsLayout.Parent = actionsContainer

-- Estados dos toggles
local spectateActive = false

-- Fun√ß√£o para criar toggle com checkbox tradicional
local function createActionToggle(text, callback)
	local toggleFrame = Instance.new("Frame")
	toggleFrame.Size = UDim2.new(1, 0, 0, 40)
	toggleFrame.BackgroundColor3 = Color3.fromRGB(60, 60, 70)
	toggleFrame.BackgroundTransparency = 0.2
	toggleFrame.Parent = actionsContainer
	Instance.new("UICorner", toggleFrame).CornerRadius = UDim.new(0, 8)

	-- Checkbox quadrado
	local checkbox = Instance.new("TextButton")
	checkbox.Size = UDim2.new(0, 20, 0, 20)
	checkbox.Position = UDim2.new(0, 10, 0.5, -10)
	checkbox.BackgroundColor3 = Color3.fromRGB(80, 80, 90) -- Fundo do checkbox
	checkbox.Text = "" -- Sem texto inicialmente
	checkbox.Font = Enum.Font.SourceSansBold
	checkbox.TextSize = 16
	checkbox.TextColor3 = Color3.fromRGB(255, 255, 255)
	checkbox.Parent = toggleFrame
	Instance.new("UICorner", checkbox).CornerRadius = UDim.new(0, 4)

	-- Label do texto
	local label = Instance.new("TextLabel")
	label.Size = UDim2.new(1, -40, 1, 0)
	label.Position = UDim2.new(0, 40, 0, 0)
	label.BackgroundTransparency = 1
	label.Text = text
	label.Font = Enum.Font.SourceSansBold
	label.TextSize = 14
	label.TextColor3 = Color3.fromRGB(255, 255, 255)
	label.TextXAlignment = Enum.TextXAlignment.Left
	label.Parent = toggleFrame

	local enabled = false

	checkbox.MouseButton1Click:Connect(function()
		if not selectedPlayer then
			print("‚ùå Selecione um jogador primeiro!")
			return
		end

		enabled = not enabled

		if enabled then
			-- Checkbox marcado
			checkbox.Text = "‚úì"
			checkbox.BackgroundColor3 = Color3.fromRGB(0, 150, 0) -- Verde
		else
			-- Checkbox desmarcado
			checkbox.Text = ""
			checkbox.BackgroundColor3 = Color3.fromRGB(80, 80, 90) -- Cinza
		end

		if callback then
			callback(enabled)
		end
	end)

	-- Esconder inicialmente
	toggleFrame.Visible = false

	return toggleFrame
end

-- Bot√£o de teleporte (a√ß√£o √∫nica, n√£o toggle)
local tpBtn = Instance.new("TextButton")
tpBtn.Size = UDim2.new(1, 0, 0, 40)
tpBtn.BackgroundColor3 = Color3.fromRGB(80, 50, 150)
tpBtn.BackgroundTransparency = 0.2
tpBtn.Text = "üìç TELEPORTAR"
tpBtn.Font = Enum.Font.SourceSansBold
tpBtn.TextSize = 14
tpBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
tpBtn.Parent = actionsContainer
Instance.new("UICorner", tpBtn).CornerRadius = UDim.new(0, 8)

-- Toggles para a√ß√µes
local spectateToggle = createActionToggle("üëÅÔ∏è ESPECTAR", function(enabled)
	spectateActive = enabled
	if enabled and selectedPlayer then
		startSpectate(selectedPlayer)
		print("üëÅÔ∏è Spectate ATIVADO para " .. selectedPlayer.Name)
	else
		stopSpectate()
		print("üëÅÔ∏è Spectate DESATIVADO")
	end
end)



-- Esconder a√ß√µes inicialmente
tpBtn.Visible = false
spectateToggle.Visible = false

-- Fun√ß√£o simples para criar bot√£o de jogador
local function createPlayerButton(player)
	if not player or player == LocalPlayer then return end

	local btn = Instance.new("TextButton")
	btn.Name = player.Name .. "_Simple"
	btn.Size = UDim2.new(1, -8, 0, 45) -- Maior para fonte maior
	btn.BackgroundColor3 = Color3.fromRGB(50, 50, 60)
	btn.Text = player.DisplayName .. " (@" .. player.Name .. ")"
	btn.Font = Enum.Font.SourceSansBold -- Negrito
	btn.TextSize = 16 -- Fonte maior
	btn.TextColor3 = Color3.fromRGB(255, 255, 255)
	btn.TextXAlignment = Enum.TextXAlignment.Center -- CENTRALIZADO
	btn.Parent = playersList
	Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 6)

	btn.MouseButton1Click:Connect(function()
		-- Desselecionar anterior (SELE√á√ÉO √öNICA)
		for _, button in pairs(playerButtons) do
			if button:IsA("TextButton") and button ~= btn then
				button.TextColor3 = Color3.fromRGB(255, 255, 255) -- Branco normal
			end
		end

		-- Selecionar atual - S√ì TEXTO AMARELO
		btn.TextColor3 = Color3.fromRGB(255, 255, 0) -- AMARELO
		selectedPlayer = player

		-- Mostrar a√ß√µes
		tpBtn.Visible = true
		spectateToggle.Visible = true


		-- Resetar estados dos toggles quando selecionar novo jogador
		if spectateActive then
			spectateActive = false
			stopSpectate()
		end

	end)

	playerButtons[player] = btn
	return btn
end

-- Fun√ß√£o simples para atualizar lista
local function updatePlayersList()
	-- Limpar lista
	for _, child in ipairs(playersList:GetChildren()) do
		if child:IsA("TextButton") then
			child:Destroy()
		end
	end
	playerButtons = {}

	-- Criar bot√µes para todos os players
	for _, player in ipairs(Players:GetPlayers()) do
		if player ~= LocalPlayer then
			createPlayerButton(player)
		end
	end

	-- Aplicar pesquisa se existir
	if searchBox and searchBox.Text and searchBox.Text ~= "" then
		local searchTerm = searchBox.Text:lower()
		for player, button in pairs(playerButtons) do
			local nameMatch = player.Name:lower():find(searchTerm)
			local displayMatch = player.DisplayName:lower():find(searchTerm)
			button.Visible = nameMatch or displayMatch
		end
	end

	-- Ajustar canvas
	playersList.CanvasSize = UDim2.new(0, 0, 0, playersLayout.AbsoluteContentSize.Y)
end

-- Conectar pesquisa
searchBox:GetPropertyChangedSignal("Text"):Connect(function()
	updatePlayersList()
end)

-- Conectar bot√µes de a√ß√£o
tpBtn.MouseButton1Click:Connect(function()
	if selectedPlayer then
		instantTPTo(selectedPlayer)
	end
end)

-- Os toggles j√° t√™m suas pr√≥prias fun√ß√µes de callback
-- N√£o precisamos de conex√µes adicionais

-- Fun√ß√£o para atualizar contador de jogadores
local function updatePlayerCounter()
	local playerCount = 0
	for _, player in ipairs(Players:GetPlayers()) do
		if player ~= LocalPlayer then
			playerCount = playerCount + 1
		end
	end
	playerCounter.Text = playerCount .. " jogadores"
end

-- Inicializar lista simples
updatePlayersList()
updatePlayerCounter()

-- Atualizar contador quando players entram/saem
Players.PlayerAdded:Connect(function(player)
	if player ~= LocalPlayer then
		updatePlayerCounter()
	end
end)

Players.PlayerRemoving:Connect(function(player)
	if player ~= LocalPlayer then
		updatePlayerCounter()
	end
end)

print("‚úÖ DEBUG: Players Page SIMPLIFICADA reimplementada com sucesso")

-- ESP Page
local espCategory = createCategory(espPage, "ESP Settings")

local espToggle = createToggle(espCategory, "ESP Ativado", function(enabled)
	espEnabled = enabled
	for _, p in ipairs(Players:GetPlayers()) do refreshESPForPlayer(p) end
end)

local nameToggle = createToggle(espCategory, "Mostrar Nome", function(enabled)
	showName = enabled
end)

local healthToggle = createToggle(espCategory, "Mostrar Vida", function(enabled)
	showHealth = enabled
end)

local modeBtn = Instance.new("TextButton")
modeBtn.Size = UDim2.new(1, 0, 0, 40)
modeBtn.BackgroundColor3 = Color3.fromRGB(80, 50, 150)
modeBtn.BackgroundTransparency = 0.2
modeBtn.Text = "Modo: " .. espMode
modeBtn.Font = Enum.Font.SourceSans
modeBtn.TextSize = 14
modeBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
modeBtn.Parent = espCategory
Instance.new("UICorner", modeBtn).CornerRadius = UDim.new(0, 8)

modeBtn.MouseButton1Click:Connect(function()
	espMode = (espMode == "Cheio") and "Bordas" or "Cheio"
	modeBtn.Text = "Modo: " .. espMode
	for _, p in ipairs(Players:GetPlayers()) do refreshESPForPlayer(p) end
end)

local autoEspToggle = createToggle(espCategory, "ESP Autom√°tico (Vis√≠vel/Invis√≠vel)", function(enabled)
	espAutoEnabled = enabled
	for _, p in ipairs(Players:GetPlayers()) do refreshESPForPlayer(p) end
end)

-- Skeleton Toggle
local skeletonToggle = createToggle(espCategory, "Esqueleto (ESP de Corpo)", function(enabled)
	showSkeleton = enabled
	for _, p in ipairs(Players:GetPlayers()) do refreshESPForPlayer(p) end
end)

-- Box Toggle
local boxToggle = createToggle(espCategory, "Box (Caixa 3D)", function(enabled)
	showBox = enabled
	for _, p in ipairs(Players:GetPlayers()) do refreshESPForPlayer(p) end
end)

-- Box Color Picker
local boxColorFrame = Instance.new("Frame")
boxColorFrame.Size = UDim2.new(1, 0, 0, 40)
boxColorFrame.BackgroundTransparency = 1
boxColorFrame.Parent = espCategory

local boxColorLabel = Instance.new("TextLabel")
boxColorLabel.Size = UDim2.new(0.5, 0, 1, 0)
boxColorLabel.BackgroundTransparency = 1
boxColorLabel.Text = "Cor da Box:"
boxColorLabel.Font = Enum.Font.GothamMedium
boxColorLabel.TextSize = 14
boxColorLabel.TextColor3 = Color3.fromRGB(220, 220, 240)
boxColorLabel.TextXAlignment = Enum.TextXAlignment.Left
boxColorLabel.Parent = boxColorFrame

local boxColorBtn = Instance.new("TextButton")
boxColorBtn.Size = UDim2.new(0.5, 0, 0, 30)
boxColorBtn.Position = UDim2.new(0.5, 0, 0.5, -15)
boxColorBtn.BackgroundColor3 = BOX_COLOR
boxColorBtn.Text = ""
boxColorBtn.Parent = boxColorFrame
Instance.new("UICorner", boxColorBtn).CornerRadius = UDim.new(0, 8)

boxColorBtn.MouseButton1Click:Connect(function()
	local colors = {
		Color3.fromRGB(255, 255, 255), -- Branco
		Color3.fromRGB(255, 0, 0),     -- Vermelho
		Color3.fromRGB(0, 255, 0),     -- Verde
		Color3.fromRGB(0, 0, 255),     -- Azul
		Color3.fromRGB(255, 255, 0),   -- Amarelo
		Color3.fromRGB(255, 0, 255),   -- Magenta
		Color3.fromRGB(0, 255, 255),   -- Ciano
	}
	local currentIndex = 1
	for i, color in ipairs(colors) do
		if BOX_COLOR == color then
			currentIndex = i
			break
		end
	end
	currentIndex = (currentIndex % #colors) + 1
	BOX_COLOR = colors[currentIndex]
	boxColorBtn.BackgroundColor3 = BOX_COLOR
	for _, p in ipairs(Players:GetPlayers()) do refreshESPForPlayer(p) end
end)

-- Lines Toggle
local linesToggle = createToggle(espCategory, "Lines (Linhas)", function(enabled)
	showLines = enabled
	for _, p in ipairs(Players:GetPlayers()) do refreshESPForPlayer(p) end
end)

-- Lines Mode Dropdown
local linesModeFrame = Instance.new("Frame")
linesModeFrame.Size = UDim2.new(1, 0, 0, 40)
linesModeFrame.BackgroundTransparency = 1
linesModeFrame.Parent = espCategory

local linesModeBtn = Instance.new("TextButton")
linesModeBtn.Size = UDim2.new(1, 0, 0, 40)
linesModeBtn.BackgroundColor3 = Color3.fromRGB(80, 50, 150)
linesModeBtn.BackgroundTransparency = 0.2
linesModeBtn.Text = "Modo Lines: " .. linesMode .. " ‚ñº"
linesModeBtn.Font = Enum.Font.SourceSans
linesModeBtn.TextSize = 14
linesModeBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
linesModeBtn.Parent = linesModeFrame
Instance.new("UICorner", linesModeBtn).CornerRadius = UDim.new(0, 8)

local linesModeDropdown = Instance.new("Frame")
linesModeDropdown.Size = UDim2.new(1, 0, 0, 80)
linesModeDropdown.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
linesModeDropdown.BackgroundTransparency = 0.1
linesModeDropdown.Visible = false
linesModeDropdown.Parent = linesModeFrame
Instance.new("UICorner", linesModeDropdown).CornerRadius = UDim.new(0, 8)

local linesModeLayout = Instance.new("UIListLayout")
linesModeLayout.Padding = UDim.new(0, 2)
linesModeLayout.Parent = linesModeDropdown

local linesModes = {"Center", "Sky"}
for _, mode in ipairs(linesModes) do
	local optionBtn = Instance.new("TextButton")
	optionBtn.Size = UDim2.new(1, 0, 0, 25)
	optionBtn.BackgroundColor3 = Color3.fromRGB(60, 60, 70)
	optionBtn.BackgroundTransparency = 0.3
	optionBtn.Text = mode
	optionBtn.Font = Enum.Font.SourceSans
	optionBtn.TextSize = 12
	optionBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
	optionBtn.Parent = linesModeDropdown
	Instance.new("UICorner", optionBtn).CornerRadius = UDim.new(0, 6)

	optionBtn.MouseButton1Click:Connect(function()
		linesMode = mode
		linesModeBtn.Text = "Modo Lines: " .. linesMode .. " ‚ñº"
		linesModeDropdown.Visible = false
		for _, p in ipairs(Players:GetPlayers()) do refreshESPForPlayer(p) end
	end)
end

linesModeBtn.MouseButton1Click:Connect(function()
	linesModeDropdown.Visible = not linesModeDropdown.Visible
end)

-- Lines Color Picker
local linesColorFrame = Instance.new("Frame")
linesColorFrame.Size = UDim2.new(1, 0, 0, 40)
linesColorFrame.BackgroundTransparency = 1
linesColorFrame.Parent = espCategory

local linesColorLabel = Instance.new("TextLabel")
linesColorLabel.Size = UDim2.new(0.5, 0, 1, 0)
linesColorLabel.BackgroundTransparency = 1
linesColorLabel.Text = "Cor das Lines:"
linesColorLabel.Font = Enum.Font.GothamMedium
linesColorLabel.TextSize = 14
linesColorLabel.TextColor3 = Color3.fromRGB(220, 220, 240)
linesColorLabel.TextXAlignment = Enum.TextXAlignment.Left
linesColorLabel.Parent = linesColorFrame

local linesColorBtn = Instance.new("TextButton")
linesColorBtn.Size = UDim2.new(0.5, 0, 0, 30)
linesColorBtn.Position = UDim2.new(0.5, 0, 0.5, -15)
linesColorBtn.BackgroundColor3 = LINES_COLOR
linesColorBtn.Text = ""
linesColorBtn.Parent = linesColorFrame
Instance.new("UICorner", linesColorBtn).CornerRadius = UDim.new(0, 8)

linesColorBtn.MouseButton1Click:Connect(function()
	local colors = {
		Color3.fromRGB(255, 255, 255), -- Branco
		Color3.fromRGB(255, 0, 0),     -- Vermelho
		Color3.fromRGB(0, 255, 0),     -- Verde
		Color3.fromRGB(0, 0, 255),     -- Azul
		Color3.fromRGB(255, 255, 0),   -- Amarelo
		Color3.fromRGB(255, 0, 255),   -- Magenta
		Color3.fromRGB(0, 255, 255),   -- Ciano
	}
	local currentIndex = 1
	for i, color in ipairs(colors) do
		if LINES_COLOR == color then
			currentIndex = i
			break
		end
	end
	currentIndex = (currentIndex % #colors) + 1
	LINES_COLOR = colors[currentIndex]
	linesColorBtn.BackgroundColor3 = LINES_COLOR
	for _, p in ipairs(Players:GetPlayers()) do refreshESPForPlayer(p) end
end)

-- ESP Position Selector
local positionBtn = Instance.new("TextButton")
positionBtn.Size = UDim2.new(1, 0, 0, 40)
positionBtn.BackgroundColor3 = Color3.fromRGB(80, 50, 150)
positionBtn.BackgroundTransparency = 0.2
positionBtn.Text = "Posi√ß√£o: " .. espPosition
positionBtn.Font = Enum.Font.SourceSans
positionBtn.TextSize = 14
positionBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
positionBtn.Parent = espCategory
Instance.new("UICorner", positionBtn).CornerRadius = UDim.new(0, 8)

positionBtn.MouseButton1Click:Connect(function()
	if espPosition == "Topo" then
		espPosition = "Baixo"
	elseif espPosition == "Baixo" then
		espPosition = "Lado"
	else
		espPosition = "Topo"
	end
	positionBtn.Text = "Posi√ß√£o: " .. espPosition
	for _, p in ipairs(Players:GetPlayers()) do refreshESPForPlayer(p) end
end)

-- Aimbot Page - Melhorado
local rageCategory = createCategory(aimbotPage, "Aimbot")

-- Toggles organizados em grid
local togglesFrame = Instance.new("Frame")
togglesFrame.Size = UDim2.new(1, 0, 0, 160)
togglesFrame.BackgroundTransparency = 1
togglesFrame.Parent = rageCategory

local aimbotToggle = createToggle(togglesFrame, "Aimbot", function(enabled)
	aimbotEnabled = enabled
end)
aimbotToggle.Position = UDim2.new(0, 0, 0, 0)
aimbotToggle.Size = UDim2.new(0.48, 0, 0, 50)

local fovToggle = createToggle(togglesFrame, "Mostrar FOV", function(enabled)
	aimbotShowFOV = enabled
	local existing = gui:FindFirstChild("FOVCircle")
	if aimbotShowFOV then
		if not existing then
			local fovCircle = Instance.new("Frame")
			fovCircle.Name = "FOVCircle"
			fovCircle.Size = UDim2.fromOffset(aimbotFOV * 3, aimbotFOV * 3)
			fovCircle.Position = UDim2.new(0.5, -aimbotFOV * 1.5, 0.5, -aimbotFOV * 1.5)
			fovCircle.BackgroundTransparency = 1
			fovCircle.BorderSizePixel = 0
			fovCircle.ZIndex = 10
			Instance.new("UICorner", fovCircle).CornerRadius = UDim.new(1, 0)
			local stroke = Instance.new("UIStroke")
			stroke.Color = Color3.new(1, 1, 1)
			stroke.Thickness = 2
			stroke.Parent = fovCircle
			fovCircle.Parent = gui
		end
	else
		if existing then existing:Destroy() end
	end
end)
fovToggle.Position = UDim2.new(0.52, 0, 0, 0)
fovToggle.Size = UDim2.new(0.48, 0, 0, 50)

local visibleToggle = createToggle(togglesFrame, "Apenas Vis√≠veis", function(enabled)
	aimbotOnlyVisible = enabled
end)
visibleToggle.Position = UDim2.new(0, 0, 0, 50)
visibleToggle.Size = UDim2.new(0.48, 0, 0, 50)

local npcToggle = createToggle(togglesFrame, "Mirar NPCs", function(enabled)
	aimbotOnNPCs = enabled
end)
npcToggle.Position = UDim2.new(0.52, 0, 0, 50)
npcToggle.Size = UDim2.new(0.48, 0, 0, 50)

local fovZeroToggle = createToggle(togglesFrame, "FOV Zero", function(enabled)
	aimbotShowFOVZero = enabled
	local existing = gui:FindFirstChild("FOVZeroCircle")
	if aimbotShowFOVZero then
		if not existing then
			local fovZeroCircle = Instance.new("Frame")
			fovZeroCircle.Name = "FOVZeroCircle"
			fovZeroCircle.Size = UDim2.fromOffset(aimbotFOVZero * 2, aimbotFOVZero * 2)
			fovZeroCircle.Position = UDim2.new(0.5, -aimbotFOVZero, 0.5, -aimbotFOVZero)
			fovZeroCircle.BackgroundTransparency = 0.8
			fovZeroCircle.BackgroundColor3 = Color3.fromRGB(255, 0, 255)
			fovZeroCircle.BorderSizePixel = 0
			fovZeroCircle.ZIndex = 10
			Instance.new("UICorner", fovZeroCircle).CornerRadius = UDim.new(1, 0)
			fovZeroCircle.Parent = gui
		end
	else
		if existing then existing:Destroy() end
	end
end)
fovZeroToggle.Position = UDim2.new(0, 0, 0, 100)
fovZeroToggle.Size = UDim2.new(0.48, 0, 0, 50)

-- Dropdown para alvo
local targetDropdownFrame = Instance.new("Frame")
targetDropdownFrame.Size = UDim2.new(1, 0, 0, 50)
targetDropdownFrame.BackgroundTransparency = 1
targetDropdownFrame.Parent = rageCategory

local targetDropdownBtn = Instance.new("TextButton")
targetDropdownBtn.Size = UDim2.new(1, 0, 0, 40)
targetDropdownBtn.BackgroundColor3 = Color3.fromRGB(80, 50, 150)
targetDropdownBtn.BackgroundTransparency = 0.2
targetDropdownBtn.Text = "Alvo: " .. aimbotTarget .. " ‚ñº"
targetDropdownBtn.Font = Enum.Font.SourceSans
targetDropdownBtn.TextSize = 14
targetDropdownBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
targetDropdownBtn.Parent = targetDropdownFrame
Instance.new("UICorner", targetDropdownBtn).CornerRadius = UDim.new(0, 8)

local targetDropdownList = Instance.new("Frame")
targetDropdownList.Size = UDim2.new(1, 0, 0, 80)
targetDropdownList.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
targetDropdownList.BackgroundTransparency = 0.1
targetDropdownList.Visible = false
targetDropdownList.Parent = targetDropdownFrame
Instance.new("UICorner", targetDropdownList).CornerRadius = UDim.new(0, 8)

local targetListLayout = Instance.new("UIListLayout")
targetListLayout.Padding = UDim.new(0, 2)
targetListLayout.Parent = targetDropdownList

for _, option in ipairs(targetOptions) do
	local optionBtn = Instance.new("TextButton")
	optionBtn.Size = UDim2.new(1, 0, 0, 25)
	optionBtn.BackgroundColor3 = Color3.fromRGB(60, 60, 70)
	optionBtn.BackgroundTransparency = 0.3
	optionBtn.Text = option
	optionBtn.Font = Enum.Font.SourceSans
	optionBtn.TextSize = 12
	optionBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
	optionBtn.Parent = targetDropdownList
	Instance.new("UICorner", optionBtn).CornerRadius = UDim.new(0, 6)

	optionBtn.MouseButton1Click:Connect(function()
		aimbotTarget = option
		targetDropdownBtn.Text = "Alvo: " .. aimbotTarget .. " ‚ñº"
		targetDropdownList.Visible = false
		targetDropdownOpen = false
	end)
end

targetDropdownBtn.MouseButton1Click:Connect(function()
	targetDropdownOpen = not targetDropdownOpen
	targetDropdownList.Visible = targetDropdownOpen
end)

-- Toggle m√≥vel
local mobileToggle = createToggle(rageCategory, "Aimbot M√≥vel - FOV segue mouse", function(enabled)
	aimbotMobile = enabled
end)

-- FOV Slider compacto - Mais pequeno e mais grosso
local fovFrame = Instance.new("Frame")
fovFrame.Size = UDim2.new(1, 0, 0, 45)
fovFrame.BackgroundTransparency = 1
fovFrame.Parent = rageCategory

local fovTitle = Instance.new("TextLabel")
fovTitle.BackgroundTransparency = 1
fovTitle.Size = UDim2.new(0.4, 0, 0, 14)
fovTitle.Font = Enum.Font.SourceSansBold
fovTitle.TextSize = 12
fovTitle.TextColor3 = Color3.fromRGB(196, 181, 253)
fovTitle.Text = "FOV"
fovTitle.Parent = fovFrame

local fovLabel = Instance.new("TextLabel")
fovLabel.BackgroundTransparency = 1
fovLabel.Size = UDim2.new(0.3, 0, 0, 14)
fovLabel.Position = UDim2.new(0.4, 0, 0, 0)
fovLabel.Font = Enum.Font.SourceSans
fovLabel.TextSize = 12
fovLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
fovLabel.Text = aimbotFOV
fovLabel.Parent = fovFrame

local fovInput = Instance.new("TextBox")
fovInput.Size = UDim2.new(0.3, 0, 0, 14)
fovInput.Position = UDim2.new(0.7, 0, 0, 0)
fovInput.BackgroundColor3 = Color3.fromRGB(40, 40, 48)
fovInput.TextColor3 = Color3.fromRGB(255, 255, 255)
fovInput.Text = tostring(aimbotFOV)
fovInput.Font = Enum.Font.SourceSans
fovInput.TextSize = 10
fovInput.Parent = fovFrame
Instance.new("UICorner", fovInput).CornerRadius = UDim.new(0, 4)

local fovSlider = Instance.new("Frame")
fovSlider.Size = UDim2.new(0.8, 0, 0, 16)
fovSlider.Position = UDim2.new(0.1, 0, 0, 16)
fovSlider.BackgroundColor3 = Color3.fromRGB(60, 60, 70)
fovSlider.Parent = fovFrame
Instance.new("UICorner", fovSlider).CornerRadius = UDim.new(0, 5)

local fovFill = Instance.new("Frame")
fovFill.Size = UDim2.fromScale(aimbotFOV / 200, 1)
fovFill.BackgroundColor3 = Color3.fromRGB(139, 92, 246)
fovFill.Parent = fovSlider
Instance.new("UICorner", fovFill).CornerRadius = UDim.new(0, 4)

local fovDragging = false
fovSlider.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 then
		fovDragging = true
	end
end)
UserInputService.InputEnded:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 then
		fovDragging = false
	end
end)
UserInputService.InputChanged:Connect(function(input)
	if fovDragging and input.UserInputType == Enum.UserInputType.MouseMovement then
		local mousePos = UserInputService:GetMouseLocation()
		local sliderPos = fovSlider.AbsolutePosition
		local sliderSize = fovSlider.AbsoluteSize
		local relativeX = math.clamp((mousePos.X - sliderPos.X) / sliderSize.X, 0, 1)
		aimbotFOV = math.floor(0 + relativeX * 200)
		fovLabel.Text = aimbotFOV
		fovInput.Text = tostring(aimbotFOV)
		fovFill.Size = UDim2.fromScale(relativeX, 1)
		local existing = gui:FindFirstChild("FOVCircle")
		if existing then
			existing.Size = UDim2.fromOffset(aimbotFOV * 3, aimbotFOV * 3)
			existing.Position = UDim2.new(0.5, -aimbotFOV * 1.5, 0.5, -aimbotFOV * 1.5)
		end
	end
end)

fovInput.FocusLost:Connect(function(enterPressed)
	if enterPressed then
		local newValue = tonumber(fovInput.Text)
		if newValue and newValue >= 0 and newValue <= 200 then
			aimbotFOV = newValue
			fovLabel.Text = aimbotFOV
			fovFill.Size = UDim2.fromScale(aimbotFOV / 200, 1)
			local existing = gui:FindFirstChild("FOVCircle")
			if existing then
				existing.Size = UDim2.fromOffset(aimbotFOV * 3, aimbotFOV * 3)
				existing.Position = UDim2.new(0.5, -aimbotFOV * 1.5, 0.5, -aimbotFOV * 1.5)
			end
		else
			fovInput.Text = tostring(aimbotFOV)
		end
	end
end)

-- Smooth Slider compacto - Mais pequeno e mais grosso
local smoothFrame = Instance.new("Frame")
smoothFrame.Size = UDim2.new(1, 0, 0, 45)
smoothFrame.BackgroundTransparency = 1
smoothFrame.Parent = rageCategory

local smoothTitle = Instance.new("TextLabel")
smoothTitle.BackgroundTransparency = 1
smoothTitle.Size = UDim2.new(0.4, 0, 0, 14)
smoothTitle.Font = Enum.Font.SourceSansBold
smoothTitle.TextSize = 12
smoothTitle.TextColor3 = Color3.fromRGB(196, 181, 253)
smoothTitle.Text = "Smooth"
smoothTitle.Parent = smoothFrame

local smoothLabel = Instance.new("TextLabel")
smoothLabel.BackgroundTransparency = 1
smoothLabel.Size = UDim2.new(0.6, 0, 0, 14)
smoothLabel.Position = UDim2.new(0.4, 0, 0, 0)
smoothLabel.Font = Enum.Font.SourceSans
smoothLabel.TextSize = 12
smoothLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
smoothLabel.Text = aimbotSmooth
smoothLabel.Parent = smoothFrame

local smoothSlider = Instance.new("Frame")
smoothSlider.Size = UDim2.new(0.8, 0, 0, 16)
smoothSlider.Position = UDim2.new(0.1, 0, 0, 16)
smoothSlider.BackgroundColor3 = Color3.fromRGB(60, 60, 70)
smoothSlider.Parent = smoothFrame
Instance.new("UICorner", smoothSlider).CornerRadius = UDim.new(0, 5)

local smoothFill = Instance.new("Frame")
smoothFill.Size = UDim2.fromScale(aimbotSmooth / 20, 1)
smoothFill.BackgroundColor3 = Color3.fromRGB(236, 72, 153)
smoothFill.Parent = smoothSlider
Instance.new("UICorner", smoothFill).CornerRadius = UDim.new(0, 4)

local smoothDragging = false
smoothSlider.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 then
		smoothDragging = true
	end
end)
UserInputService.InputEnded:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 then
		smoothDragging = false
	end
end)
UserInputService.InputChanged:Connect(function(input)
	if smoothDragging and input.UserInputType == Enum.UserInputType.MouseMovement then
		local mousePos = UserInputService:GetMouseLocation()
		local sliderPos = smoothSlider.AbsolutePosition
		local sliderSize = smoothSlider.AbsoluteSize
		local relativeX = math.clamp((mousePos.X - sliderPos.X) / sliderSize.X, 0, 1)
		aimbotSmooth = math.floor(0 + relativeX * 20)
		smoothLabel.Text = aimbotSmooth
		smoothFill.Size = UDim2.fromScale(aimbotSmooth / 20, 1)
	end
end)

-- Bind Button
local bindBtn = Instance.new("TextButton")
bindBtn.Size = UDim2.new(1, 0, 0, 45)
bindBtn.BackgroundColor3 = Color3.fromRGB(80, 50, 150)
bindBtn.BackgroundTransparency = 0.2
bindBtn.Text = "Bind: " .. aimbotBindString
bindBtn.Font = Enum.Font.SourceSans
bindBtn.TextSize = 14
bindBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
bindBtn.Parent = rageCategory
Instance.new("UICorner", bindBtn).CornerRadius = UDim.new(0, 8)

local bindListening = false
bindBtn.MouseButton1Click:Connect(function()
	bindListening = true
	bindBtn.Text = "Press any key..."
	bindBtn.BackgroundColor3 = Color3.fromRGB(255, 200, 0)
end)

UserInputService.InputBegan:Connect(function(input, processed)
	if bindListening and not processed then
		if input.UserInputType == Enum.UserInputType.Keyboard then
			aimbotBind = input.KeyCode
			aimbotBindString = input.KeyCode.Name
		elseif input.UserInputType == Enum.UserInputType.MouseButton1 then
			aimbotBind = "MouseLeft"
			aimbotBindString = "MouseLeft"
		elseif input.UserInputType == Enum.UserInputType.MouseButton2 then
			aimbotBind = "MouseRight"
			aimbotBindString = "MouseRight"
		elseif input.UserInputType == Enum.UserInputType.MouseButton3 then
			aimbotBind = "MouseMiddle"
			aimbotBindString = "MouseMiddle"
		elseif input.UserInputType == Enum.UserInputType.MouseButton4 then
			aimbotBind = "MouseButton4"
			aimbotBindString = "MouseButton4"
		elseif input.UserInputType == Enum.UserInputType.MouseButton5 then
			aimbotBind = "MouseButton5"
			aimbotBindString = "MouseButton5"
		else
			return -- Ignore other inputs
		end
		bindBtn.Text = "Bind: " .. aimbotBindString
		bindBtn.BackgroundColor3 = Color3.fromRGB(80, 50, 150)
		bindListening = false
	end
end)

-- Loop para atualizar FOV m√≥vel
RunService.RenderStepped:Connect(function()
	if aimbotShowFOV and aimbotMobile then
		local fovCircle = gui:FindFirstChild("FOVCircle")
		if fovCircle then
			local mousePos = UserInputService:GetMouseLocation()
			fovCircle.Position = UDim2.new(0, mousePos.X - aimbotFOV * 1.5, 0, mousePos.Y - aimbotFOV * 1.5)
		end
	end
end)

-- Util Page - Reorganizada e Otimizada
local miscCategory = createCategory(utilPage, "Utilit√°rios")

-- ========= SUBCATEGORIA: MOVIMENTO =========
local movementSubCategory = Instance.new("Frame")
movementSubCategory.Size = UDim2.new(1, -20, 0, 0)
movementSubCategory.Position = UDim2.new(0, 10, 0, 10)
movementSubCategory.BackgroundColor3 = Color3.fromRGB(25, 25, 45)
movementSubCategory.BackgroundTransparency = 0.3
movementSubCategory.Parent = miscCategory
Instance.new("UICorner", movementSubCategory).CornerRadius = UDim.new(0, 10)

local movementTitle = Instance.new("TextLabel")
movementTitle.Size = UDim2.new(1, -20, 0, 25)
movementTitle.Position = UDim2.new(0, 10, 0, 5)
movementTitle.BackgroundTransparency = 1
movementTitle.Text = "üöÄ MOVIMENTO"
movementTitle.Font = Enum.Font.SourceSansBold
movementTitle.TextSize = 14
movementTitle.TextColor3 = Color3.fromRGB(139, 92, 246)
movementTitle.TextXAlignment = Enum.TextXAlignment.Left
movementTitle.Parent = movementSubCategory

local movementContent = Instance.new("Frame")
movementContent.Size = UDim2.new(1, -20, 1, -35)
movementContent.Position = UDim2.new(0, 10, 0, 30)
movementContent.BackgroundTransparency = 1
movementContent.Parent = movementSubCategory

local movementLayout = Instance.new("UIListLayout")
movementLayout.Padding = UDim.new(0, 6)
movementLayout.Parent = movementContent

-- Toggle do fly no menu - controle principal
local flyToggle = createToggle(movementContent, "‚úàÔ∏è Fly (F) - Ativa Noclip Auto", function(enabled)
	if enabled then
		-- Quando ativado no menu, for√ßa ativa√ß√£o
		if not FlySystem.flying then
			toggleFly()
		end
		-- Ativar noclip automaticamente quando fly √© ligado
		noclip = true
		-- Ativar noclip no toggle do menu tamb√©m
		if noclipToggle then
			local checkbox = noclipToggle:FindFirstChildOfClass("TextButton")
			if checkbox then
				checkbox.BackgroundColor3 = Color3.fromRGB(139, 92, 246)
			end
		end
	else
		-- Quando desativado no menu, for√ßa desativa√ß√£o
		if FlySystem.flying then
			FlySystem:toggleFly() -- For√ßa desativa√ß√£o
			flying = false
		end
	end
end)

-- Atualizar toggle visual baseado no estado do fly
task.spawn(function()
	while true do
		task.wait(0.1)
		if flyToggle then
			local checkbox = flyToggle:FindFirstChildOfClass("TextButton")
			if checkbox then
				if FlySystem.flying then
					checkbox.BackgroundColor3 = Color3.fromRGB(139, 92, 246)
				else
					checkbox.BackgroundColor3 = Color3.fromRGB(60, 60, 70)
				end
			end
		end
	end
end)

local noclipToggle = createToggle(movementContent, "üîì Noclip - Atravessa Tudo", function(enabled)
	noclip = enabled
	if enabled then
		print("üîì Noclip ATIVADO - Pode atravessar TODAS as paredes!")
	else
		print("üîí Noclip DESATIVADO")
	end
end)

-- Sistema Noclip Melhorado - Loop cont√≠nuo para garantir que atravessa TODAS as paredes
task.spawn(function()
	while true do
		task.wait(0.05) -- Verifica√ß√£o frequente
		if noclip then
			local character = LocalPlayer.Character
			if character then
				-- Desabilitar colis√£o em TODAS as partes do personagem
				forEachCharacterPart(character, function(part)
					if part.CanCollide == true then
						part.CanCollide = false
					end
				end)
				-- Tamb√©m desabilitar colis√£o em partes espec√≠ficas que podem ser esquecidas
				local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
				if humanoidRootPart and humanoidRootPart.CanCollide == true then
					humanoidRootPart.CanCollide = false
				end
			end
		end
	end
end)

-- ========= SUBCATEGORIA: BOOSTS =========
local boostsSubCategory = Instance.new("Frame")
boostsSubCategory.Size = UDim2.new(1, -20, 0, 0)
boostsSubCategory.Position = UDim2.new(0, 10, 0, 180)
boostsSubCategory.BackgroundColor3 = Color3.fromRGB(25, 45, 25)
boostsSubCategory.BackgroundTransparency = 0.3
boostsSubCategory.Parent = miscCategory
Instance.new("UICorner", boostsSubCategory).CornerRadius = UDim.new(0, 10)

local boostsTitle = Instance.new("TextLabel")
boostsTitle.Size = UDim2.new(1, -20, 0, 25)
boostsTitle.Position = UDim2.new(0, 10, 0, 5)
boostsTitle.BackgroundTransparency = 1
boostsTitle.Text = "‚ö° BOOSTS (Persistentes)"
boostsTitle.Font = Enum.Font.SourceSansBold
boostsTitle.TextSize = 14
boostsTitle.TextColor3 = Color3.fromRGB(92, 246, 139)
boostsTitle.TextXAlignment = Enum.TextXAlignment.Left
boostsTitle.Parent = boostsSubCategory

local boostsContent = Instance.new("Frame")
boostsContent.Size = UDim2.new(1, -20, 1, -35)
boostsContent.Position = UDim2.new(0, 10, 0, 30)
boostsContent.BackgroundTransparency = 1
boostsContent.Parent = boostsSubCategory

local boostsLayout = Instance.new("UIListLayout")
boostsLayout.Padding = UDim.new(0, 6)
boostsLayout.Parent = boostsContent

local speedToggle = createToggle(boostsContent, "üèÉ Speed Boost - Persistente", function(enabled)
	speedBoostEnabled = enabled
	local character = LocalPlayer.Character
	if character then
		local humanoid = character:FindFirstChildOfClass("Humanoid")
		if humanoid then
			if enabled then
				originalWalkSpeed = humanoid.WalkSpeed
				humanoid.WalkSpeed = speedBoostValue
			else
				humanoid.WalkSpeed = originalWalkSpeed
			end
		end
	end
end)

local jumpToggle = createToggle(boostsContent, "ü¶ò Jump Power Boost - Persistente", function(enabled)
	jumpPowerBoostEnabled = enabled
	local character = LocalPlayer.Character
	if character then
		local humanoid = character:FindFirstChildOfClass("Humanoid")
		if humanoid then
			if enabled then
				originalJumpPower = humanoid.JumpPower
				humanoid.JumpPower = jumpPowerBoostValue
			else
				humanoid.JumpPower = originalJumpPower
			end
		end
	end
end)

-- Sistema de Persist√™ncia - Reaplicar boosts ap√≥s respawn
LocalPlayer.CharacterAdded:Connect(function(character)
	-- Aguardar o personagem carregar completamente
	task.wait(0.5)

	local humanoid = character:FindFirstChildOfClass("Humanoid")
	if humanoid then
		-- Reaplicar speed boost se estiver ativado
		if speedBoostEnabled then
			humanoid.WalkSpeed = speedBoostValue
			print("‚ö° Speed Boost reaplicado ap√≥s respawn: " .. speedBoostValue)
		end

		-- Reaplicar jump boost se estiver ativado
		if jumpPowerBoostEnabled then
			humanoid.JumpPower = jumpPowerBoostValue
			print("ü¶ò Jump Power reaplicado ap√≥s respawn: " .. jumpPowerBoostValue)
		end
	end
end)

-- Speed Boost Slider
local speedTitle = Instance.new("TextLabel")
speedTitle.BackgroundTransparency = 1
speedTitle.Size = UDim2.new(1, 0, 0, 20)
speedTitle.Font = Enum.Font.SourceSansBold
speedTitle.TextSize = 12
speedTitle.TextColor3 = Color3.fromRGB(196, 181, 253)
speedTitle.Text = "Velocidade: " .. speedBoostValue
speedTitle.Parent = boostsContent

local speedSlider = Instance.new("Frame")
speedSlider.Size = UDim2.new(1, 0, 0, 8)
speedSlider.BackgroundColor3 = Color3.fromRGB(60, 60, 70)
speedSlider.Parent = boostsContent
Instance.new("UICorner", speedSlider).CornerRadius = UDim.new(0, 4)

local speedFill = Instance.new("Frame")
speedFill.Size = UDim2.fromScale(speedBoostValue / 200, 1)
speedFill.BackgroundColor3 = Color3.fromRGB(139, 92, 246)
speedFill.Parent = speedSlider
Instance.new("UICorner", speedFill).CornerRadius = UDim.new(0, 4)

local speedDragging = false
speedSlider.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 then
		speedDragging = true
	end
end)
UserInputService.InputEnded:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 then
		speedDragging = false
	end
end)
UserInputService.InputChanged:Connect(function(input)
	if speedDragging and input.UserInputType == Enum.UserInputType.MouseMovement then
		local mousePos = UserInputService:GetMouseLocation()
		local sliderPos = speedSlider.AbsolutePosition
		local sliderSize = speedSlider.AbsoluteSize
		local relativeX = math.clamp((mousePos.X - sliderPos.X) / sliderSize.X, 0, 1)
		speedBoostValue = math.floor(0 + relativeX * 200)
		speedTitle.Text = "Velocidade: " .. speedBoostValue
		speedFill.Size = UDim2.fromScale(relativeX, 1)
		if speedBoostEnabled then
			local character = LocalPlayer.Character
			if character then
				local humanoid = character:FindFirstChildOfClass("Humanoid")
				if humanoid then
					humanoid.WalkSpeed = speedBoostValue
				end
			end
		end
	end
end)

-- Jump Power Slider
local jumpTitle = Instance.new("TextLabel")
jumpTitle.BackgroundTransparency = 1
jumpTitle.Size = UDim2.new(1, 0, 0, 20)
jumpTitle.Font = Enum.Font.SourceSansBold
jumpTitle.TextSize = 12
jumpTitle.TextColor3 = Color3.fromRGB(196, 181, 253)
jumpTitle.Text = "Pulo: " .. jumpPowerBoostValue
jumpTitle.Parent = boostsContent

local jumpSlider = Instance.new("Frame")
jumpSlider.Size = UDim2.new(1, 0, 0, 8)
jumpSlider.BackgroundColor3 = Color3.fromRGB(60, 60, 70)
jumpSlider.Parent = boostsContent
Instance.new("UICorner", jumpSlider).CornerRadius = UDim.new(0, 4)

local jumpFill = Instance.new("Frame")
jumpFill.Size = UDim2.fromScale(jumpPowerBoostValue / 200, 1)
jumpFill.BackgroundColor3 = Color3.fromRGB(236, 72, 153)
jumpFill.Parent = jumpSlider
Instance.new("UICorner", jumpFill).CornerRadius = UDim.new(0, 4)

local jumpDragging = false
jumpSlider.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 then
		jumpDragging = true
	end
end)
UserInputService.InputEnded:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 then
		jumpDragging = false
	end
end)
UserInputService.InputChanged:Connect(function(input)
	if jumpDragging and input.UserInputType == Enum.UserInputType.MouseMovement then
		local mousePos = UserInputService:GetMouseLocation()
		local sliderPos = jumpSlider.AbsolutePosition
		local sliderSize = jumpSlider.AbsoluteSize
		local relativeX = math.clamp((mousePos.X - sliderPos.X) / sliderSize.X, 0, 1)
		jumpPowerBoostValue = math.floor(0 + relativeX * 200)
		jumpTitle.Text = "Pulo: " .. jumpPowerBoostValue
		jumpFill.Size = UDim2.fromScale(relativeX, 1)
		if jumpPowerBoostEnabled then
			local character = LocalPlayer.Character
			if character then
				local humanoid = character:FindFirstChildOfClass("Humanoid")
				if humanoid then
					humanoid.JumpPower = jumpPowerBoostValue
				end
			end
		end
	end
end)

-- ========= SUBCATEGORIA: UTILIT√ÅRIOS =========
local utilsSubCategory = Instance.new("Frame")
utilsSubCategory.Size = UDim2.new(1, -20, 0, 0)
utilsSubCategory.Position = UDim2.new(0, 10, 0, 350)
utilsSubCategory.BackgroundColor3 = Color3.fromRGB(45, 25, 25)
utilsSubCategory.BackgroundTransparency = 0.3
utilsSubCategory.Parent = miscCategory
Instance.new("UICorner", utilsSubCategory).CornerRadius = UDim.new(0, 10)

local utilsTitle = Instance.new("TextLabel")
utilsTitle.Size = UDim2.new(1, -20, 0, 25)
utilsTitle.Position = UDim2.new(0, 10, 0, 5)
utilsTitle.BackgroundTransparency = 1
utilsTitle.Text = "üõ†Ô∏è UTILIT√ÅRIOS"
utilsTitle.Font = Enum.Font.SourceSansBold
utilsTitle.TextSize = 14
utilsTitle.TextColor3 = Color3.fromRGB(246, 139, 92)
utilsTitle.TextXAlignment = Enum.TextXAlignment.Left
utilsTitle.Parent = utilsSubCategory

local utilsContent = Instance.new("Frame")
utilsContent.Size = UDim2.new(1, -20, 1, -35)
utilsContent.Position = UDim2.new(0, 10, 0, 30)
utilsContent.BackgroundTransparency = 1
utilsContent.Parent = utilsSubCategory

local utilsLayout = Instance.new("UIListLayout")
utilsLayout.Padding = UDim.new(0, 6)
utilsLayout.Parent = utilsContent

local infiniteJumpToggle = createToggle(utilsContent, "üîÑ Infinite Jump", function(enabled)
	infiniteJumpEnabled = enabled
	if enabled then
		UserInputService.JumpRequest:Connect(function()
			local character = LocalPlayer.Character
			if character then
				local humanoid = character:FindFirstChildOfClass("Humanoid")
				if humanoid then
					humanoid:ChangeState(Enum.HumanoidStateType.Jumping)
				end
			end
		end)
	end
end)

local antiKickToggle = createToggle(utilsContent, "üõ°Ô∏è Anti-Kick", function(enabled)
	antiKickEnabled = enabled
	if enabled then
		local mt = getrawmetatable(game)
		local old = mt.__namecall
		setreadonly(mt, false)
		mt.__namecall = newcclosure(function(self, ...)
			local args = {...}
			local method = getnamecallmethod()
			if method == "Kick" then
				return nil
			end
			return old(self, ...)
		end)
		setreadonly(mt, true)
	end
end)

-- Ajustar tamanhos das subcategorias
movementSubCategory.Size = UDim2.new(1, -20, 0, movementLayout.AbsoluteContentSize.Y + 40)
boostsSubCategory.Size = UDim2.new(1, -20, 0, boostsLayout.AbsoluteContentSize.Y + 40)
utilsSubCategory.Size = UDim2.new(1, -20, 0, utilsLayout.AbsoluteContentSize.Y + 40)

-- Make draggable
local dragging = false
local dragStart = nil
local startPos = nil

header.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 then
		dragging = true
		dragStart = input.Position
		startPos = mainFrame.Position
	end
end)

UserInputService.InputChanged:Connect(function(input)
	if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
		local delta = input.Position - dragStart
		mainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
	end
end)

UserInputService.InputEnded:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 then
		dragging = false
	end
end)

-- Tab connections
tabPlayers.MouseButton1Click:Connect(function() setTab("PLAYERS") end)
tabESP.MouseButton1Click:Connect(function() setTab("ESP") end)
tabAimbot.MouseButton1Click:Connect(function() setTab("AIMBOT") end)
tabUtil.MouseButton1Click:Connect(function() setTab("UTIL") end)

-- Mostrar/ocultar painel
local function showPanel(show: boolean)
	if panelVisible == show then return end
	panelVisible = show
	mainFrame.Visible = show

	if show then
		-- Salvar estado atual do mouse
		prevMouseBehavior = UserInputService.MouseBehavior
		prevMouseIconEnabled = UserInputService.MouseIconEnabled

		-- Liberar mouse para usar a interface
		UserInputService.MouseBehavior = Enum.MouseBehavior.Default
		UserInputService.MouseIconEnabled = true

		-- Atualizar lista de players quando abrir o painel
		rebuildPlayersList()
	else
		-- Restaurar estado do mouse quando fechar
		if prevMouseBehavior then
				UserInputService.MouseBehavior = prevMouseBehavior
		end
		if prevMouseIconEnabled ~= nil then
				UserInputService.MouseIconEnabled = prevMouseIconEnabled
		end
	end
end

-- Fun√ß√£o para criar player buttons
local function addPlayerToRow(p: Player)
	if p == LocalPlayer then return end

	local playerBtn = Instance.new("TextButton")
	playerBtn.Name = p.Name
	playerBtn.Size = UDim2.new(1, -8, 0, 40)
	playerBtn.BackgroundColor3 = Color3.fromRGB(36,36,44)
	playerBtn.Text = ""
	playerBtn.Parent = playersList
	Instance.new("UICorner", playerBtn).CornerRadius = UDim.new(0, 6)

	local nameLbl = Instance.new("TextLabel")
	nameLbl.BackgroundTransparency = 1
	nameLbl.Size = UDim2.new(1, -8, 1, 0)
	nameLbl.Position = UDim2.new(0, 8, 0, 0)
	nameLbl.Font = Enum.Font.GothamSemibold
	nameLbl.TextSize = 14
	nameLbl.TextColor3 = Color3.fromRGB(255,255,255)
	nameLbl.TextXAlignment = Enum.TextXAlignment.Left

	nameLbl.Text = p.Name
	nameLbl.Parent = playerBtn

	local selectionIndicator = Instance.new("Frame")
	selectionIndicator.Size = UDim2.new(0, 4, 1, -8)
	selectionIndicator.Position = UDim2.new(0, 2, 0, 4)
	selectionIndicator.BackgroundColor3 = Color3.fromRGB(0, 170, 255)
	selectionIndicator.Visible = false
	selectionIndicator.Parent = playerBtn
	Instance.new("UICorner", selectionIndicator).CornerRadius = UDim.new(0, 2)

	playerBtn.MouseButton1Click:Connect(function()
		-- Desselecionar anterior
		for _, btn in ipairs(playersList:GetChildren()) do
			if btn:IsA("TextButton") then
				local indicator = btn:FindFirstChildOfClass("Frame")
				if indicator then
					indicator.Visible = false
					btn.BackgroundColor3 = Color3.fromRGB(36,36,44)
				end
				local lbl = btn:FindFirstChildOfClass("TextLabel")
				if lbl then
					lbl.TextColor3 = Color3.fromRGB(255,255,255) -- Branco
				end
			end
		end

		-- Selecionar atual
		selectionIndicator.Visible = true
		playerBtn.BackgroundColor3 = Color3.fromRGB(50,50,60)
		nameLbl.TextColor3 = Color3.fromRGB(255, 255, 0) -- Amarelo
		selectedPlayer = p

		-- Show actions panel
		actionsPanel.Visible = true
		tpBtn.Visible = true
		spectateBtn.Visible = true
	end)

	return playerBtn
end

local function clearPlayersList()
	for _, c in ipairs(playersList:GetChildren()) do
		if c:IsA("TextButton") then c:Destroy() end
	end
end

local function rebuildPlayersList()
    print("üîß DEBUG: rebuildPlayersList() chamada")

    -- Limpar lista existente
    for _, child in ipairs(playersList:GetChildren()) do
        if child:IsA("Frame") or child:IsA("TextButton") then
            child:Destroy()
        end
    end

    -- Limpar cache
    playerButtons = {}

    print("üîß DEBUG: Lista limpa, criando bot√µes...")

    -- Criar bot√µes simples para todos os jogadores (sem ordena√ß√£o/filtros por enquanto)
    for _, plr in ipairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer then
            print("üîß DEBUG: Criando bot√£o para " .. plr.Name)
            createPlayerButton(plr)
        end
    end

    -- Aplicar filtro de pesquisa se existir
    if searchBox and searchBox.Text and searchBox.Text ~= "" then
        print("üîß DEBUG: Aplicando filtro de pesquisa: " .. searchBox.Text)
        applySearch(searchBox.Text)
    end

    -- Ajustar tamanho do canvas
    task.wait() -- Esperar um frame
    if playersLayout then
        playersList.CanvasSize = UDim2.new(0, 0, 0, playersLayout.AbsoluteContentSize.Y)
    end

    print("‚úÖ DEBUG: Lista de jogadores atualizada: " .. #Players:GetPlayers() .. " players")
end

Players.PlayerAdded:Connect(function(p)
	rebuildPlayersList()
end)

Players.PlayerRemoving:Connect(function(p)
	if selectedPlayer == p then
		selectedPlayer = nil
	end
	rebuildPlayersList()
end)

-- Aimbot Logic
local function getClosestPlayer()
	if not aimbotEnabled then return nil end

	local closestPlayer = nil
	local closestDistance = aimbotFOV

	local camera = workspace.CurrentCamera
	local centerPos = aimbotMobile and UserInputService:GetMouseLocation() or Vector2.new(camera.ViewportSize.X / 2, camera.ViewportSize.Y / 2)

	for _, player in ipairs(Players:GetPlayers()) do
		if player ~= LocalPlayer and player.Character then
			local character = player.Character
			local targetPart = nil
			if aimbotTarget == "Cabe√ßa" then
				targetPart = character:FindFirstChild("Head")
			elseif aimbotTarget == "Peito" then
				targetPart = character:FindFirstChild("UpperTorso") or character:FindFirstChild("Torso")
			end

			if targetPart then
				local screenPos, onScreen = camera:WorldToViewportPoint(targetPart.Position)
				if onScreen then
					local distance = (Vector2.new(screenPos.X, screenPos.Y) - centerPos).Magnitude
					if distance <= closestDistance then
						if aimbotOnlyVisible then
							local myChar = LocalPlayer.Character
							if myChar then
								local myRoot = myChar:FindFirstChild("HumanoidRootPart")
								local targetRoot = character:FindFirstChild("HumanoidRootPart")
								if myRoot and targetRoot then
									local raycastResult = workspace:Raycast(myRoot.Position, (targetRoot.Position - myRoot.Position).Unit * (targetRoot.Position - myRoot.Position).Magnitude)
									if raycastResult and raycastResult.Instance and not raycastResult.Instance:IsDescendantOf(character) then
										continue -- Not visible
									end
								end
							end
						end
						closestDistance = distance
						closestPlayer = player
					end
				end
			end
		end
	end

	return closestPlayer
end

-- Aimbot aim function
local function aimAt(targetPlayer)
	if not targetPlayer or not targetPlayer.Character then return end

	local camera = workspace.CurrentCamera
	local character = targetPlayer.Character

	local targetPart = nil
	if aimbotTarget == "Cabe√ßa" then
		targetPart = character:FindFirstChild("Head")
	elseif aimbotTarget == "Peito" then
		targetPart = character:FindFirstChild("UpperTorso") or character:FindFirstChild("Torso")
	end

	if not targetPart then return end

	local targetPos = targetPart.Position
	local currentCFrame = camera.CFrame
	local targetCFrame = CFrame.new(currentCFrame.Position, targetPos)

	local smoothFactor = aimbotSmooth / 10
	if smoothFactor < 0.1 then smoothFactor = 0.1 end

	camera.CFrame = currentCFrame:Lerp(targetCFrame, smoothFactor)
end

-- Aimbot activation - custom bind
local aimbotKeyHeld = false

UserInputService.InputBegan:Connect(function(input, processed)
	if processed or not aimbotEnabled then return end

	local shouldActivate = false
	if aimbotBindString == "MouseLeft" and input.UserInputType == Enum.UserInputType.MouseButton1 then
		shouldActivate = true
	elseif aimbotBindString == "MouseRight" and input.UserInputType == Enum.UserInputType.MouseButton2 then
		shouldActivate = true
	elseif aimbotBindString == "MouseMiddle" and input.UserInputType == Enum.UserInputType.MouseButton3 then
		shouldActivate = true
	elseif aimbotBindString == "MouseButton4" and input.UserInputType == Enum.UserInputType.MouseButton4 then
		shouldActivate = true
	elseif aimbotBindString == "MouseButton5" and input.UserInputType == Enum.UserInputType.MouseButton5 then
		shouldActivate = true
	elseif input.KeyCode and input.KeyCode.Name == aimbotBindString then
		shouldActivate = true
	end

	if shouldActivate then
		aimbotKeyHeld = true
	end
end)

UserInputService.InputEnded:Connect(function(input, processed)
	if processed then return end

	local shouldDeactivate = false
	if aimbotBindString == "MouseLeft" and input.UserInputType == Enum.UserInputType.MouseButton1 then
		shouldDeactivate = true
	elseif aimbotBindString == "MouseRight" and input.UserInputType == Enum.UserInputType.MouseButton2 then
		shouldDeactivate = true
	elseif aimbotBindString == "MouseMiddle" and input.UserInputType == Enum.UserInputType.MouseButton3 then
		shouldDeactivate = true
	elseif aimbotBindString == "MouseButton4" and input.UserInputType == Enum.UserInputType.MouseButton4 then
		shouldDeactivate = true
	elseif aimbotBindString == "MouseButton5" and input.UserInputType == Enum.UserInputType.MouseButton5 then
		shouldDeactivate = true
	elseif input.KeyCode and input.KeyCode.Name == aimbotBindString then
		shouldDeactivate = true
	end

	if shouldDeactivate then
		aimbotKeyHeld = false
	end
end)

-- Continuous aiming when key/button held
RunService.RenderStepped:Connect(function()
	if aimbotKeyHeld and aimbotEnabled then
		local target = getClosestPlayer()
		if target then
			aimAt(target)
		end
	end
end)

-- üîß DEBUG: Comentando sistema de atualiza√ß√£o autom√°tica que pode estar causando travamento
-- startRealTimeUpdates()

-- üîß DEBUG: Comentando configura√ß√£o de eventos que podem causar recurs√£o
-- for _, player in ipairs(Players:GetPlayers()) do
-- 	if player ~= LocalPlayer then
-- 		setupPlayerEvents(player)
-- 	end
-- end

-- üîß DEBUG: Comentando eventos globais que podem causar loop
-- Players.PlayerAdded:Connect(function(player)
-- 	if player ~= LocalPlayer then
-- 		setupPlayerEvents(player)
-- 		task.wait(0.1)
-- 		rebuildPlayersList()
-- 	end
-- end)

-- Players.PlayerRemoving:Connect(function(player)
-- 	if playerButtons[player] then
-- 		playerButtons[player]:Destroy()
-- 		playerButtons[player] = nil
-- 	end
-- 	if selectedPlayer == player then
-- 		selectedPlayer = nil
-- 		if actionsPanel then
-- 			actionsPanel.Visible = false
-- 		end
-- 	end
-- 	task.wait(0.1)
-- 	rebuildPlayersList()
-- end)

print("üîß DEBUG: Sistema de atualiza√ß√£o autom√°tica DESABILITADO")
print("üîß DEBUG: Eventos de players DESABILITADOS")

-- Boot
local success, err = pcall(function()
	rebuildPlayersList()
	for _, p in ipairs(Players:GetPlayers()) do
		if p ~= LocalPlayer and p.Character then
			refreshESPForPlayer(p)
		end
	end
end)

if success then
	print("‚úÖ Painel pronto! Sistema de Biblioteca - Selecione jogadores para ver a√ß√µes!")
	print("üîë CONTROLES: M (Abrir/Fechar) | P (Destravar Mouse) | F (Fly) | H (Agarrar) | X (Cancelar)")
	print("‚òÅÔ∏è SISTEMA FLY/NOCLIP ORIGINAL INTEGRADO! VELOCIDADE INICIAL: 1")
else
	warn("‚ùå Erro ao inicializar painel: " .. tostring(err))
end



-- Input geral - Corrigido para evitar conflitos
UserInputService.InputBegan:Connect(function(input, processed)
	if processed then return end

	-- Menu toggle (M) - Prioridade m√°xima
	if input.KeyCode == UI_TOGGLE_KEY then
		showPanel(not panelVisible)
		return -- Impede outros processamentos
	end

	-- Outros controles
	if input.KeyCode == FREEFLY_TOGGLE_KEY then
		toggleFly()
	elseif input.KeyCode == UNLOCK_MOUSE_KEY then
		unlockMouse()
	end
end)
